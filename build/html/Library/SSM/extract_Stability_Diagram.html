
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><body><div class="banner"><a href="../../index.html"><img alt="Logo" class="logo" src="../../logo.png" style="float:right" width="200"/></a></div><html><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--

                    This HTML was auto-generated from MATLAB code.
                    To make changes, update the MATLAB code and republish this document.
                --><title>Extract Stablitiy Diagram</title><meta content="MATLAB 9.14" name="generator"/><link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/><meta content="2023-09-09" name="DC.date"/><meta content="extract_Stability_Diagram.m" name="DC.source"/><style type="text/css">
            html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

            html { min-height:100%; margin-bottom:1px; }
            html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
            html body td { vertical-align:top; text-align:left; }

            h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
            h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
            h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

            a { color:#005fce; text-decoration:none; }
            a:hover { color:#005fce; text-decoration:underline; }
            a:visited { color:#004aa0; text-decoration:none; }

            p { padding:0px; margin:0px 0px 20px; }
            img { padding:0px; margin:0px 0px 20px; border:none; }
            p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

            ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
            ul li { padding:0px; margin:0px 0px 7px 0px; }
            ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
            ul li ol li { list-style:decimal; }
            ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
            ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
            ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
            ol li ol li { list-style-type:lower-alpha; }
            ol li ul { padding-top:7px; }
            ol li ul li { list-style:square; }

            .content { font-size:1.2em; line-height:140%; padding: 20px; }

            pre, code { font-size:12px; }
            tt { font-size: 1.2em; }
            pre { margin:0px 0px 20px; }
            pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
            pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
            pre.error { color:red; }

            @media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

            span.keyword { color:#0000FF }
            span.comment { color:#228B22 }
            span.string { color:#A020F0 }
            span.untermstring { color:#B20000 }
            span.syscmd { color:#B28C00 }
            span.typesection { color:#A0522D }

            .footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
            .footer p { margin:0px; }
            .footer a { color:#878787; }
            .footer a:hover { color:#878787; text-decoration:underline; }
            .footer a:visited { color:#878787; }

            table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
            table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }

            .center {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 50%;
              }



        </style></head><body><div class="content"><h1>Extract Stablitiy Diagram</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">Extract Stability Diagram</a></li><li><a href="#3">Parse input parameters</a></li><li><a href="#4">Compute Autonomous SSM</a></li><li><a href="#5">Reduced dynamics ODEfunction</a></li><li><a href="#6">Set up continuation problem</a></li><li><a href="#7">Continuation arguments</a></li><li><a href="#8">Continuation</a></li><li><a href="#9">Continue Period Doubling branches</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> SD = extract_Stability_Diagram(obj,resModes, order, omRange, epsRange, parName, p0,varargin)
        </pre><h2 id="2">Extract Stability Diagram</h2><p>This function extracts the stability diagram of the trivial fixed point of parametrically excited systems (also known as InceStrutt diagram) in  a range of forcing frequency around the principal subharmonic 2:1 resonance using the reduced order model computed by the SSM. An appropriate SSM is constructed based on the resonant spectrum of system. Using continuation periodic orbits are detected and period doubling / saddle node bifurcations which appear at the boundaries of stable regions around these resonances are tracked and continued.</p><p>IC = EXTRACE_STABILITY_DIAGRAM(OBJ, RESMODES, ORDER, OMRANGE, EPSRANGE, PARNAME, P0, VARARGIN)</p><div><ul><li><tt>resModes</tt>:     Modes of the Eigenspace over which SSM is computed</li></ul></div><div><ul><li><tt>order</tt>:     order of SSM epansion</li></ul></div><div><ul><li><tt>omRange</tt> :     range of forcing frequency over which stability diagram is               computed</li></ul></div><div><ul><li><tt>epsRange</tt>:     range of forcing amplitude over which stability diagram is               computed</li></ul></div><div><ul><li><tt>parName</tt> :     'amp' / 'freq' determines which parameter is released initially               when looking for bifurcations.</li></ul></div><div><ul><li><tt>p0</tt>      :     Initial parameters for continuation               p0(1) contains forcing frequency, has to be in omRange               p0(2) contains epsilon, has to be in epsRange</li></ul></div><div><ul><li><tt>varargin</tt>:     { ['PD' or 'SN'], PlotSD}, whether the resonance tongue is to               obtained using PD or SN bifurcations,               option to suppress plot of SD</li></ul></div><div><ul><li><tt>SD</tt>:           Stability Diagram data struct</li></ul></div><p>See also: COCO/EXTRACT_STABILITY_DIAGRAM</p><pre class="codeinput">startStab = tic;
        </pre><h2 id="3">Parse input parameters</h2><p>flag for bifurctaion type and plotting</p><pre class="codeinput"><span class="keyword">if</span> numel(varargin)==2
        SNflag = strcmp(varargin{1},<span class="string">'SN'</span>);
        PlotSD = varargin{2};
<span class="keyword">elseif</span> numel(varargin)==1
    <span class="keyword">if</span> islogical(varargin{1})
        PlotSD = varargin{1};
        SNflag = false;
    <span class="keyword">else</span>
        PlotSD = true;
        SNflag = strcmp(varargin{1},<span class="string">'SN'</span>);
    <span class="keyword">end</span>
<span class="keyword">else</span>
    SNflag = false;
    PlotSD = true;
<span class="keyword">end</span>

<span class="keyword">if</span> SNflag
    bifType = <span class="string">'SN'</span>;
<span class="keyword">else</span>
    bifType = <span class="string">'PD'</span>;
<span class="keyword">end</span>
        </pre><h2 id="4">Compute Autonomous SSM</h2><pre class="codeinput">obj.<a href="../../Library/Manifold/choose_E.html">choose_E</a>(resModes);

<span class="comment">% Initialise external forcing frequency</span>
obj.System.Omega = p0(1);

<span class="comment">% Compute SSM</span>
[W, R] = obj.<a href="../../Library/Manifold/compute_whisker.html">compute_whisker</a>(order);
        </pre><h2 id="5">Reduced dynamics ODEfunction</h2><p>Data for odefunction</p><pre class="codeinput"><span class="keyword">if</span> obj.FRCOptions.omDepNonAuto <span class="comment">% Assume strong dependence of coefficients on Omega</span>

    fdata   = struct(<span class="string">'order'</span>, order,<span class="string">'R'</span>,R,<span class="string">'W'</span>,W);
    odefun    = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian.html">ode_2DSSM_cartesian</a>(t,x,p,fdata,obj);
    odefun_dx = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian_DFDX.html">ode_2DSSM_cartesian_DFDX</a>(t,x,p,fdata,obj);
    odefun_dp = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian_DFDP.html">ode_2DSSM_cartesian_DFDP</a>(t,x,p,fdata,obj);
<span class="keyword">else</span>

    <span class="comment">% Use a fixed ROM, computed for a single forcing frequency and use it</span>
    <span class="comment">% for the full frequency span</span>

    <span class="comment">% Compute Reduced dynamics and sensitivity coefficients</span>
    obj.System.Omega = obj.FRCOptions.omDepNonAutoVal;

    fdata   = struct(<span class="string">'order'</span>, order,<span class="string">'R'</span>,R,<span class="string">'S'</span>,S);
    odefun    = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian_fixROM.html">ode_2DSSM_cartesian_fixROM</a>(t,x,p,fdata);
    odefun_dx = @(t,x,p) ode_2DSSM_cartesian_DFDX_fixROM(t,x,p,fdata);
    odefun_dp = @(t,x,p) ode_2DSSM_cartesian_DFDP_fixROM(t,x,p,fdata,obj.Options.contribNonAuto);
<span class="keyword">end</span>

funcs  = {odefun,odefun_dx,odefun_dp};
        </pre><h2 id="6">Set up continuation problem</h2><p>Initial conditions</p><pre class="codeinput"><span class="keyword">switch</span> bifType
    <span class="keyword">case</span> <span class="string">'PD'</span>
        periodsRatio = 1;
    <span class="keyword">case</span> <span class="string">'SN'</span>
        periodsRatio = 2;
<span class="keyword">end</span>

T = periodsRatio *2*pi/p0(1); <span class="comment">% Forcing period of initial condition</span>


t0 = linspace(0,T,101);
x0 = zeros(101,2);

<span class="comment">% Build Problem</span>
prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob); <span class="comment">%set default options</span>
prob = coco_set(prob, <span class="string">'ode'</span>, <span class="string">'autonomous'</span>, false,<span class="string">'vectorized'</span>, false);

coll_args = [funcs, {t0, x0, {<span class="string">'om'</span> <span class="string">'eps'</span> }, p0}];
prob = ode_isol2po(prob, <span class="string">''</span>, coll_args{:});

<span class="comment">% Fix period of response to forcing frequency to detect PD bifurcation</span>
[data, uidx] = coco_get_func_data(prob, <span class="string">'po.orb.coll'</span>, <span class="string">'data'</span>, <span class="string">'uidx'</span>);
maps = data.coll_seg.maps;
omData = struct();
omData.periodsRatio = periodsRatio;
prob = coco_add_func(prob, <span class="string">'OmegaT'</span>, @OmegaT, @OmegaT_du, omData, <span class="string">'zero'</span>,<span class="keyword">...</span>
    <span class="string">'uidx'</span>, [uidx(maps.T_idx), uidx(maps.p_idx(1))]);
        </pre><h2 id="7">Continuation arguments</h2><pre class="codeinput"><span class="keyword">switch</span> parName
    <span class="keyword">case</span> <span class="string">'freq'</span>

        isomega = true;
        cont_args = { 1, { <span class="string">'om'</span>, <span class="string">'po.period'</span> }, omRange };
        parRange = epsRange; <span class="comment">%Range of 2nd continuation parameter</span>
    <span class="keyword">case</span> <span class="string">'amp'</span>
        isomega = false;
        cont_args = {1, {<span class="string">'eps'</span>, <span class="string">'po.period'</span>}, epsRange };
        parRange = omRange; <span class="comment">%Range of 2nd continuation parameter</span>
    <span class="keyword">otherwise</span>
        error(<span class="string">'Continuation parameter should be freq or amp'</span>);
<span class="keyword">end</span>
        </pre><h2 id="8">Continuation</h2><pre class="codeinput">runid = <span class="string">'ROM_detect_bif'</span>;
bd = coco(prob,runid,[],cont_args{:});
        </pre><h2 id="9">Continue Period Doubling branches</h2><pre class="codeinput"><span class="keyword">switch</span> bifType
    <span class="keyword">case</span> <span class="string">'PD'</span>
        labs = coco_bd_labs(bd, <span class="string">'PD'</span>);
    <span class="keyword">case</span> <span class="string">'SN'</span>
        labs = coco_bd_labs(bd, <span class="string">'SN'</span>);
<span class="keyword">end</span>
<span class="keyword">if</span> obj.FRCOptions.branchSwitch
    <span class="keyword">if</span> isempty(labs)
        sprintf(<span class="string">'No bifurcations indicating a resonance tongue were detected'</span>);
        SD = [];
        <span class="keyword">return</span>
    <span class="keyword">else</span>
        epsilon = [];
        omega   = [];
        run_idx = 1;
        <span class="keyword">for</span> lab = labs

            labid = sprintf(<span class="string">'ROM_family_bif%d'</span>,run_idx ); <span class="comment">% Id of this run along family of PD bifurcations</span>
            fprintf(<span class="string">'\n Run=''%s'': Continue bifurcations from point %d in run ''%s''.\n'</span>,labid, lab, runid);

            [omega_i,epsilon_i] = stab_diag(obj,parRange,lab,runid,labid,isomega,bifType, omData);
            omega   = [omega,omega_i];
            epsilon = [epsilon,epsilon_i];
            run_idx = run_idx+1;
        <span class="keyword">end</span>
        SD.omega = omega;
        SD.epsilon = epsilon;
    <span class="keyword">end</span>

    <span class="keyword">if</span> PlotSD
        plot_Stability_Diagram(omega,epsilon,order);
    <span class="keyword">end</span>

    SD.order = order;
    totalComputationTime = toc(startStab);
    disp([<span class="string">'Total time spent on Stability Diagram computation = '</span> datestr(datenum(0,0,0,0,0,totalComputationTime),<span class="string">'HH:MM:SS'</span>)])
<span class="keyword">else</span>
    SD = [];
<span class="keyword">end</span>
        </pre><pre class="codeinput"><span class="keyword">end</span>
        </pre><pre class="codeinput"><span class="keyword">function</span>[omega,epsilon] = stab_diag(obj,parRange,lab, runid,labid,isomega, bifType, omData)
<span class="comment">% For continuation of PD bifurcation in omega and epsilon</span>

<span class="comment">% Build continuation problem</span>
prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob); <span class="comment">%set default options</span>
<span class="keyword">switch</span> bifType
    <span class="keyword">case</span> <span class="string">'PD'</span>
        prob = ode_PD2PD(prob, <span class="string">''</span>, runid, lab);
    <span class="keyword">case</span> <span class="string">'SN'</span>
        prob = ode_SN2SN(prob, <span class="string">''</span>, runid, lab);
<span class="keyword">end</span>

<span class="comment">% Fix period of response</span>
[data, uidx] = coco_get_func_data(prob, <span class="string">'po.orb.coll'</span>, <span class="string">'data'</span>, <span class="string">'uidx'</span>);
maps = data.coll_seg.maps;
prob = coco_add_func(prob, <span class="string">'OmegaT'</span>, @OmegaT, @OmegaT_du, omData, <span class="string">'zero'</span>,<span class="keyword">...</span>
            <span class="string">'uidx'</span>, [uidx(maps.T_idx), uidx(maps.p_idx(1))]);


<span class="keyword">if</span> isomega
    cont_args = {1, {<span class="string">'eps'</span> <span class="string">'om'</span> <span class="string">'po.period'</span> }, parRange};
<span class="keyword">else</span>
    cont_args = {1, {<span class="string">'om'</span> <span class="string">'po.period'</span> <span class="string">'eps'</span> }, parRange};
<span class="keyword">end</span>
bd_lab  = coco(prob, labid, [], cont_args{:});

<span class="comment">% read out omega and epsilon values along period doubling bifurcation</span>

omega = coco_bd_col(bd_lab, <span class="string">'om'</span>);
epsilon = coco_bd_col(bd_lab, <span class="string">'eps'</span>);
<span class="keyword">end</span>
        </pre><pre class="codeinput"><span class="keyword">function</span> [] = plot_Stability_Diagram(omega,epsilon,order)
figSD = gcf;
<span class="comment">% Plot in terms of omega and epsilon</span>
figure(figSD); hold <span class="string">on</span>; grid <span class="string">off</span>;
plot(omega,epsilon,<span class="string">'-'</span>,<span class="string">'LineWidth'</span>,2,<span class="string">'color'</span>,[0.4940    0.1840    0.5560],<span class="string">'DisplayName'</span>,strcat(<span class="string">'SSM-$$\mathcal{O}('</span>,num2str(order),<span class="string">')$$'</span>))
add_labels(<span class="string">'$\Omega$'</span>,<span class="string">'$\epsilon$'</span>)
add_legends(order);
<span class="comment">%title('Stability of trivial fixed point')</span>
<span class="comment">%legend(strcat('SSM-$$\mathcal{O}(',num2str(order),')$$'),...</span>
<span class="comment">%        'Interpreter','latex','Location','best');</span>
<span class="comment">%legend boxon</span>

<span class="keyword">end</span>
        </pre><pre class="codeinput"><span class="keyword">function</span> add_legends(order)
hl = legend(<span class="string">'show'</span>,<span class="string">'Location'</span>,<span class="string">'best'</span>);
set(hl, <span class="string">'Interpreter'</span>,<span class="string">'latex'</span>)
legend <span class="string">boxon</span>;
<span class="keyword">end</span>


<span class="keyword">function</span> add_labels(xlab,ylab)
xlabel(xlab,<span class="string">'Interpreter'</span>,<span class="string">'latex'</span>);
ylabel(ylab,<span class="string">'Interpreter'</span>,<span class="string">'latex'</span>);
set(gca,<span class="string">'FontSize'</span>,14);
grid <span class="string">on</span>, axis <span class="string">tight</span>; legend <span class="string">boxoff</span>;
<span class="keyword">end</span>

<span class="keyword">function</span> [data, y] = OmegaT(prob, data, u) <span class="comment">%#ok&lt;INUSL&gt;</span>
y = u(1)*u(2)-2*pi*data.periodsRatio; <span class="comment">% omega*T = 2*pi</span>
<span class="keyword">end</span>

<span class="keyword">function</span> [data, J] = OmegaT_du(prob, data, u) <span class="comment">%#ok&lt;INUSL&gt;</span>
J = [u(2) u(1)];
<span class="keyword">end</span>
        </pre><p class="footer"><br/><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB® R2023a</a><br/></p></div><!--
            ##### SOURCE BEGIN #####
            %% Extract Stablitiy Diagram
%
%%
function SD = extract_Stability_Diagram(obj,resModes, order, omRange, epsRange, parName, p0,varargin)
%% Extract Stability Diagram
% This function extracts the
% stability diagram of the trivial fixed point of parametrically excited
% systems (also known as InceStrutt diagram) in  a range of forcing frequency
% around the principal subharmonic 2:1 resonance using the reduced order model computed
% by the SSM. An appropriate SSM is constructed based on the resonant
% spectrum of system. Using continuation periodic orbits are detected and
% period doubling / saddle node bifurcations which appear at the boundaries of stable
% regions around these resonances are tracked and continued.
%
% IC = EXTRACE_STABILITY_DIAGRAM(OBJ, RESMODES, ORDER, OMRANGE, EPSRANGE, PARNAME, P0, VARARGIN)
%
%
% * |resModes|:     Modes of the Eigenspace over which SSM is computed
% 
% * |order|:     order of SSM epansion
% 
% * |omRange| :     range of forcing frequency over which stability diagram is
%               computed
% 
% * |epsRange|:     range of forcing amplitude over which stability diagram is
%               computed
% 
% * |parName| :     'amp' / 'freq' determines which parameter is released initially
%               when looking for bifurcations. 
% 
% * |p0|      :     Initial parameters for continuation
%               p0(1) contains forcing frequency, has to be in omRange
%               p0(2) contains epsilon, has to be in epsRange
% 
% * |varargin|:     { ['PD' or 'SN'], PlotSD}, whether the resonance tongue is to
%               obtained using PD or SN bifurcations, 
%               option to suppress plot of SD
%
% * |SD|:           Stability Diagram data struct
%
% See also: COCO/EXTRACT_STABILITY_DIAGRAM

startStab = tic;
%% Parse input parameters
% flag for bifurctaion type and plotting 

if numel(varargin)==2
        SNflag = strcmp(varargin{1},'SN');
        PlotSD = varargin{2};
elseif numel(varargin)==1
    if islogical(varargin{1})
        PlotSD = varargin{1};
        SNflag = false;
    else
        PlotSD = true;
        SNflag = strcmp(varargin{1},'SN');
    end
else
    SNflag = false;
    PlotSD = true;
end

if SNflag
    bifType = 'SN';
else
    bifType = 'PD';
end
%% Compute Autonomous SSM
obj.<a href="../../Library/Manifold/choose_E.html">choose_E</a>(resModes);

% Initialise external forcing frequency
obj.System.Omega = p0(1);

% Compute SSM
[W, R] = obj.<a href="../../Library/Manifold/compute_whisker.html">compute_whisker</a>(order);

%% Reduced dynamics ODEfunction
% Data for odefunction

if obj.FRCOptions.omDepNonAuto % Assume strong dependence of coefficients on Omega
    
    fdata   = struct('order', order,'R',R,'W',W);
    odefun    = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian.html">ode_2DSSM_cartesian</a>(t,x,p,fdata,obj);
    odefun_dx = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian_DFDX.html">ode_2DSSM_cartesian_DFDX</a>(t,x,p,fdata,obj);
    odefun_dp = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian_DFDP.html">ode_2DSSM_cartesian_DFDP</a>(t,x,p,fdata,obj);
else
    
    % Use a fixed ROM, computed for a single forcing frequency and use it
    % for the full frequency span

    % Compute Reduced dynamics and sensitivity coefficients
    obj.System.Omega = obj.FRCOptions.omDepNonAutoVal;
    
    fdata   = struct('order', order,'R',R,'S',S);
    odefun    = @(t,x,p) <a href="../../Library/SSM/private/ode_2DSSM_cartesian_fixROM.html">ode_2DSSM_cartesian_fixROM</a>(t,x,p,fdata);
    odefun_dx = @(t,x,p) ode_2DSSM_cartesian_DFDX_fixROM(t,x,p,fdata);
    odefun_dp = @(t,x,p) ode_2DSSM_cartesian_DFDP_fixROM(t,x,p,fdata,obj.Options.contribNonAuto);
end

funcs  = {odefun,odefun_dx,odefun_dp};

%% Set up continuation problem
% Initial conditions

switch bifType
    case 'PD'
        periodsRatio = 1;
    case 'SN'
        periodsRatio = 2;
end

T = periodsRatio *2*pi/p0(1); % Forcing period of initial condition


t0 = linspace(0,T,101);
x0 = zeros(101,2);

% Build Problem
prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob); %set default options
prob = coco_set(prob, 'ode', 'autonomous', false,'vectorized', false);

coll_args = [funcs, {t0, x0, {'om' 'eps' }, p0}];
prob = ode_isol2po(prob, '', coll_args{:});

% Fix period of response to forcing frequency to detect PD bifurcation
[data, uidx] = coco_get_func_data(prob, 'po.orb.coll', 'data', 'uidx');
maps = data.coll_seg.maps;
omData = struct();
omData.periodsRatio = periodsRatio;
prob = coco_add_func(prob, 'OmegaT', @OmegaT, @OmegaT_du, omData, 'zero',...
    'uidx', [uidx(maps.T_idx), uidx(maps.p_idx(1))]);

%% Continuation arguments
switch parName
    case 'freq'
        
        isomega = true;
        cont_args = { 1, { 'om', 'po.period' }, omRange };
        parRange = epsRange; %Range of 2nd continuation parameter
    case 'amp'
        isomega = false;
        cont_args = {1, {'eps', 'po.period'}, epsRange };
        parRange = omRange; %Range of 2nd continuation parameter
    otherwise
        error('Continuation parameter should be freq or amp');
end

%% Continuation
runid = 'ROM_detect_bif';
bd = coco(prob,runid,[],cont_args{:});


%% Continue Period Doubling branches

switch bifType
    case 'PD'
        labs = coco_bd_labs(bd, 'PD');
    case 'SN'
        labs = coco_bd_labs(bd, 'SN');
end
if obj.FRCOptions.branchSwitch
    if isempty(labs)
        sprintf('No bifurcations indicating a resonance tongue were detected');
        SD = [];
        return
    else
        epsilon = [];
        omega   = [];
        run_idx = 1;
        for lab = labs
            
            labid = sprintf('ROM_family_bif%d',run_idx ); % Id of this run along family of PD bifurcations
            fprintf('\n Run=''%s'': Continue bifurcations from point %d in run ''%s''.\n',labid, lab, runid);
            
            [omega_i,epsilon_i] = stab_diag(obj,parRange,lab,runid,labid,isomega,bifType, omData);
            omega   = [omega,omega_i];
            epsilon = [epsilon,epsilon_i];
            run_idx = run_idx+1;
        end
        SD.omega = omega;
        SD.epsilon = epsilon;
    end
    
    if PlotSD 
        plot_Stability_Diagram(omega,epsilon,order);
    end
    
    SD.order = order;
    totalComputationTime = toc(startStab);
    disp(['Total time spent on Stability Diagram computation = ' datestr(datenum(0,0,0,0,0,totalComputationTime),'HH:MM:SS')])
else
    SD = [];    
end

end


%% 
%
function[omega,epsilon] = stab_diag(obj,parRange,lab, runid,labid,isomega, bifType, omData)
% For continuation of PD bifurcation in omega and epsilon

% Build continuation problem
prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob); %set default options
switch bifType
    case 'PD'
        prob = ode_PD2PD(prob, '', runid, lab);
    case 'SN'
        prob = ode_SN2SN(prob, '', runid, lab);
end

% Fix period of response
[data, uidx] = coco_get_func_data(prob, 'po.orb.coll', 'data', 'uidx');
maps = data.coll_seg.maps;
prob = coco_add_func(prob, 'OmegaT', @OmegaT, @OmegaT_du, omData, 'zero',...
            'uidx', [uidx(maps.T_idx), uidx(maps.p_idx(1))]);


if isomega
    cont_args = {1, {'eps' 'om' 'po.period' }, parRange};
else
    cont_args = {1, {'om' 'po.period' 'eps' }, parRange};
end
bd_lab  = coco(prob, labid, [], cont_args{:});

% read out omega and epsilon values along period doubling bifurcation

omega = coco_bd_col(bd_lab, 'om');
epsilon = coco_bd_col(bd_lab, 'eps');
end


%%
%
function [] = plot_Stability_Diagram(omega,epsilon,order)
figSD = gcf;
% Plot in terms of omega and epsilon
figure(figSD); hold on; grid off;
plot(omega,epsilon,'-','LineWidth',2,'color',[0.4940    0.1840    0.5560],'DisplayName',strcat('SSM-$$\mathcal{O}(',num2str(order),')$$'))
add_labels('$\Omega$','$\epsilon$')
add_legends(order);
%title('Stability of trivial fixed point')
%legend(strcat('SSM-$$\mathcal{O}(',num2str(order),')$$'),...
%        'Interpreter','latex','Location','best');
%legend boxon

end

%%
%
function add_legends(order)
hl = legend('show','Location','best');
set(hl, 'Interpreter','latex')
legend boxon;
end


function add_labels(xlab,ylab)
xlabel(xlab,'Interpreter','latex');
ylabel(ylab,'Interpreter','latex');
set(gca,'FontSize',14);
grid on, axis tight; legend boxoff;
end

function [data, y] = OmegaT(prob, data, u) %#ok<INUSL>
y = u(1)*u(2)-2*pi*data.periodsRatio; % omega*T = 2*pi
end

function [data, J] = OmegaT_du(prob, data, u) %#ok<INUSL>
J = [u(2) u(1)];
end



            ##### SOURCE END #####
        --></body></html></body></html>