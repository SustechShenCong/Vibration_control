
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><body><div class="banner"><a href="../../index.html"><img alt="Logo" class="logo" src="../../logo.png" style="float:right" width="200"/></a></div><html><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--

                    This HTML was auto-generated from MATLAB code.
                    To make changes, update the MATLAB code and republish this document.
                --><title>SSM_ISOL2EP</title><meta content="MATLAB 9.14" name="generator"/><link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/><meta content="2023-09-09" name="DC.date"/><meta content="SSM_isol2ep.m" name="DC.source"/><style type="text/css">
            html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

            html { min-height:100%; margin-bottom:1px; }
            html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
            html body td { vertical-align:top; text-align:left; }

            h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
            h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
            h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

            a { color:#005fce; text-decoration:none; }
            a:hover { color:#005fce; text-decoration:underline; }
            a:visited { color:#004aa0; text-decoration:none; }

            p { padding:0px; margin:0px 0px 20px; }
            img { padding:0px; margin:0px 0px 20px; border:none; }
            p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

            ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
            ul li { padding:0px; margin:0px 0px 7px 0px; }
            ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
            ul li ol li { list-style:decimal; }
            ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
            ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
            ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
            ol li ol li { list-style-type:lower-alpha; }
            ol li ul { padding-top:7px; }
            ol li ul li { list-style:square; }

            .content { font-size:1.2em; line-height:140%; padding: 20px; }

            pre, code { font-size:12px; }
            tt { font-size: 1.2em; }
            pre { margin:0px 0px 20px; }
            pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
            pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
            pre.error { color:red; }

            @media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

            span.keyword { color:#0000FF }
            span.comment { color:#228B22 }
            span.string { color:#A020F0 }
            span.untermstring { color:#B20000 }
            span.syscmd { color:#B28C00 }
            span.typesection { color:#A0522D }

            .footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
            .footer p { margin:0px; }
            .footer a { color:#878787; }
            .footer a:hover { color:#878787; text-decoration:underline; }
            .footer a:visited { color:#878787; }

            table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
            table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }

            .center {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 50%;
              }



        </style></head><body><div class="content"><h1>SSM_ISOL2EP</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">SSM_ISOL2EP</a></li><li><a href="#3">Checking whether internal resonance indeed happens</a></li><li><a href="#4">SSM computation of autonomous part</a></li><li><a href="#5">SSM computation of non-autonomous part</a></li><li><a href="#6">Construct COCO-compatible vector field</a></li><li><a href="#7">continuation of reduced dynamics w.r.t. parName</a></li><li><a href="#8">extract results of reduced dynamics at sampled frequencies</a></li><li><a href="#9">FRC in physical domain</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> varargout = SSM_isol2ep(obj,oid,resonant_modes,order,mFreqs,parName,parRange,outdof,varargin)
        </pre><h2 id="2">SSM_ISOL2EP</h2><p>This function performs continuation of equilibrium points of slow dynamics. Each equilibirum point corresponds to a periodic orbit in the regular time dynamics. The continuation here starts from the guess of initial solution.</p><p>FRC = SSM_ISOL2EP(OBJ,OID,RESONANT_MODES,ORDER,MFREQS,PARNAME,PARRANGE,OUTDOF,VARARGIN)</p><div><ul><li><tt>oid</tt>:      runid of continuation</li></ul></div><div><ul><li><tt>resonant_modes</tt>:    master subspace</li></ul></div><div><ul><li><tt>order</tt>:    expansion order of SSM</li></ul></div><div><ul><li><tt>mFreqs</tt>:   internal resonance relation vector</li></ul></div><div><ul><li><tt>parName</tt>:  amp/freq continuation parameter</li></ul></div><div><ul><li><tt>parRange</tt>: continuation domain of parameter, which should be near the           value of natural frequency with index 1 in the mFreq if the continuation           parameter is freq</li></ul></div><div><ul><li><tt>outdof</tt>:   output for dof in physical domain</li></ul></div><div><ul><li><tt>varargin</tt>: [{p0,z0}], ['saveICs'] where {p0,z0} are initial solution           guesses and saveICs is a flag saving a point on trajectory as initial           condition for numerical integration</li></ul></div><pre class="codeinput">m = numel(mFreqs);
assert(numel(resonant_modes)==2*m, <span class="string">'The master subspace is not %dD.'</span>,2*m);
nPar   = obj.FRCOptions.nPar;
nCycle = obj.FRCOptions.nCycle;
        </pre><h2 id="3">Checking whether internal resonance indeed happens</h2><pre class="codeinput"><span class="keyword">if</span> isempty(obj.System.spectrum)
    [~,~,~] = obj.System.<a href="../../Library/DynamicalSystem/linear_spectral_analysis.html">linear_spectral_analysis</a>();
<span class="keyword">end</span>
<span class="comment">% eigenvalues Lambda is sorted in descending order of real parts</span>
<span class="comment">% positive imaginary part is placed first in each complex pair</span>

lambda = obj.System.spectrum.Lambda(resonant_modes);
lambdaRe = real(lambda);
lambdaIm = imag(lambda);
<a href="../../Library/SSM/private/check_spectrum_and_internal_resonance.html">check_spectrum_and_internal_resonance</a>(lambdaRe,lambdaIm,mFreqs);
        </pre><h2 id="4">SSM computation of autonomous part</h2><pre class="codeinput">obj.<a href="../../Library/Manifold/choose_E.html">choose_E</a>(resonant_modes)
<span class="comment">% compute autonomous SSM coefficients</span>
[W_0,R_0] = obj.<a href="../../Library/Manifold/compute_whisker.html">compute_whisker</a>(order);

<span class="comment">% check reduced dynamics (consistent with expected internal resonance)</span>
[beta,kappa] = <a href="../../Library/SSM/private/check_auto_reduced_dynamics.html">check_auto_reduced_dynamics</a>(R_0,order,mFreqs);
        </pre><h2 id="5">SSM computation of non-autonomous part</h2><pre class="codeinput">iNonauto = []; <span class="comment">% indices for resonant happens</span>
rNonauto = []; <span class="comment">% value of leading order contribution</span>
kNonauto = []; <span class="comment">% (pos) kappa indices with resonance</span>
kappa_set= [obj.System.Fext.data.kappa]; <span class="comment">% each row corresponds to one kappa</span>
kappa_pos = kappa_set(kappa_set&gt;0);
num_kappa = numel(kappa_pos); <span class="comment">% number of kappa pairs</span>
<span class="keyword">for</span> k=1:num_kappa
    kappak = kappa_pos(k);
    idm = find(mFreqs(:)==kappak); <span class="comment">% idm could be vector if there are two frequencies are the same</span>
    obj.System.Omega = lambdaIm(2*idm(1)-1);

    [W_1, R_1] = obj.<a href="../../Library/Manifold/compute_perturbed_whisker.html">compute_perturbed_whisker</a>(0,[],[]);

    idk = find(kappa_set==kappak);
    R_10 = R_1(idk).R.coeffs;
    r = R_10(2*idm-1);

    iNonauto = [iNonauto; idm];
    rNonauto = [rNonauto; r];
    kNonauto = [kNonauto; idk];
<span class="keyword">end</span>
        </pre><h2 id="6">Construct COCO-compatible vector field</h2><p>create data to vector field</p><pre class="codeinput">lamd  = struct();
lamd.lambdaRe = lambdaRe; lamd.lambdaIm = lambdaIm;
Nonauto = struct();
Nonauto.iNonauto = iNonauto; Nonauto.rNonauto = rNonauto; Nonauto.kNonauto = kNonauto;
[fdata,data_dir] = <a href="../../Library/SSM/private/create_reduced_dynamics_data.html">create_reduced_dynamics_data</a>(beta,kappa,lamd,mFreqs,Nonauto,W_0,W_1,order,resonant_modes);

ispolar = strcmp(obj.FRCOptions.coordinates, <span class="string">'polar'</span>);
fdata.ispolar = ispolar;
fdata.isbaseForce = obj.System.Options.BaseExcitation;

<span class="keyword">if</span> ispolar
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_polar.html">ode_2mDSSM_polar</a>(z,p,fdata);
<span class="keyword">else</span>
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_cartesian.html">ode_2mDSSM_cartesian</a>(z,p,fdata);
<span class="keyword">end</span>
funcs  = {odefun};
<span class="comment">%</span>
        </pre><h2 id="7">continuation of reduced dynamics w.r.t. parName</h2><pre class="codeinput">prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob);
<span class="comment">% construct initial solution</span>
<span class="keyword">if</span> obj.System.order==2
    p0 = [obj.System.Omega; obj.System.fext.epsilon];
<span class="keyword">else</span>
    p0 = [obj.System.Omega; obj.System.Fext.epsilon];
<span class="keyword">end</span>
[p0,z0] = <a href="../../Library/SSM/private/initial_fixed_point.html">initial_fixed_point</a>(p0,obj.FRCOptions.initialSolver,ispolar,<span class="keyword">...</span>
    odefun,nCycle,m,varargin{:});

<span class="comment">% call ep-toolbox</span>
prob = ode_isol2ep(prob, <span class="string">''</span>, funcs{:}, z0, {<span class="string">'om'</span> <span class="string">'eps'</span>}, p0);
<span class="comment">% define monitor functions to state variables</span>
[prob, args1, args2] = <a href="../../Library/SSM/private/monitor_states.html">monitor_states</a>(prob, ispolar, m);

<span class="keyword">switch</span> parName
    <span class="keyword">case</span> <span class="string">'freq'</span>
        isomega = true;
    <span class="keyword">case</span> <span class="string">'amp'</span>
        isomega = false;
    <span class="keyword">otherwise</span>
        error(<span class="string">'Continuation parameter should be freq or amp'</span>);
<span class="keyword">end</span>
<span class="keyword">if</span> strcmp(obj.FRCOptions.sampStyle, <span class="string">'uniform'</span>)
    <span class="keyword">if</span> isomega
        omSamp = linspace(parRange(1),parRange(2), nPar);
        prob   = coco_add_event(prob, <span class="string">'UZ'</span>, <span class="string">'om'</span>, omSamp);
    <span class="keyword">else</span>
        epSamp = linspace(parRange(1),parRange(2), nPar);
        prob   = coco_add_event(prob, <span class="string">'UZ'</span>, <span class="string">'eps'</span>, epSamp);
    <span class="keyword">end</span>
<span class="keyword">end</span>

runid = coco_get_id(oid, <span class="string">'ep'</span>);

fprintf(<span class="string">'\n Run=''%s'': Continue equilibria along primary branch.\n'</span>, <span class="keyword">...</span>
  runid);

<span class="keyword">if</span> isomega
    cont_args = [{<span class="string">'om'</span>},args1(:)' ,args2(:)',{<span class="string">'eps'</span>}];
<span class="keyword">else</span>
    cont_args = [{<span class="string">'eps'</span>},args1(:)' ,args2(:)',{<span class="string">'om'</span>}];
<span class="keyword">end</span>

coco(prob, runid, [], 1, cont_args, parRange);
        </pre><h2 id="8">extract results of reduced dynamics at sampled frequencies</h2><pre class="codeinput">FRC = <a href="../../Library/SSM/private/ep_reduced_results.html">ep_reduced_results</a>(runid,obj.FRCOptions.sampStyle,ispolar,isomega,args1,args2);
        </pre><h2 id="9">FRC in physical domain</h2><pre class="codeinput">FRCdata = struct();        FRCdata.isomega = isomega;
FRCdata.mFreqs  = mFreqs;  FRCdata.order  = order;
FRCdata.ispolar = ispolar; FRCdata.modes  = resonant_modes;
FRC = FRC_<a href="../../Library/Features/misc/reduced_to_full.html">reduced_to_full</a>(obj,Nonauto,<span class="string">'ep'</span>,FRC,FRCdata,W_0,W_1,outdof,varargin{:});

<span class="comment">% Plot Plot FRC in system coordinates</span>
<span class="keyword">if</span> isomega
    <a href="../../Library/SSM/private/plot_frc_full.html">plot_frc_full</a>(FRC.om,FRC.Znorm_frc,outdof,FRC.Aout_frc,FRC.st,order,<span class="string">'freq'</span>,<span class="string">'lines'</span>,{FRC.SNidx,FRC.HBidx});
<span class="keyword">else</span>
    <a href="../../Library/SSM/private/plot_frc_full.html">plot_frc_full</a>(FRC.ep,FRC.Znorm_frc,outdof,FRC.Aout_frc,FRC.st,order,<span class="string">'amp'</span>,<span class="string">'lines'</span>,{FRC.SNidx,FRC.HBidx});
<span class="keyword">end</span>

varargout{1} = FRC;
fdir = fullfile(data_dir,runid,<span class="string">'SSMep.mat'</span>);
save(fdir, <span class="string">'FRC'</span>);
        </pre><pre class="codeinput"><span class="keyword">end</span>
        </pre><p class="footer"><br/><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB® R2023a</a><br/></p></div><!--
            ##### SOURCE BEGIN #####
            %% SSM_ISOL2EP
%
%%
function varargout = SSM_isol2ep(obj,oid,resonant_modes,order,mFreqs,parName,parRange,outdof,varargin)
%% SSM_ISOL2EP 
% This function performs continuation of equilibrium points of
% slow dynamics. Each equilibirum point corresponds to a periodic orbit in
% the regular time dynamics. The continuation here starts from the guess of
% initial solution.
%
% FRC = SSM_ISOL2EP(OBJ,OID,RESONANT_MODES,ORDER,MFREQS,PARNAME,PARRANGE,OUTDOF,VARARGIN)
%
% * |oid|:      runid of continuation
% 
% * |resonant_modes|:    master subspace
% 
% * |order|:    expansion order of SSM
% 
% * |mFreqs|:   internal resonance relation vector
% 
% * |parName|:  amp/freq continuation parameter
% 
% * |parRange|: continuation domain of parameter, which should be near the
%           value of natural frequency with index 1 in the mFreq if the continuation
%           parameter is freq
% 
% * |outdof|:   output for dof in physical domain
% 
% * |varargin|: [{p0,z0}], ['saveICs'] where {p0,z0} are initial solution
%           guesses and saveICs is a flag saving a point on trajectory as initial
%           condition for numerical integration


m = numel(mFreqs);
assert(numel(resonant_modes)==2*m, 'The master subspace is not %dD.',2*m);
nPar   = obj.FRCOptions.nPar;
nCycle = obj.FRCOptions.nCycle;
%% Checking whether internal resonance indeed happens
if isempty(obj.System.spectrum)
    [~,~,~] = obj.System.<a href="../../Library/DynamicalSystem/linear_spectral_analysis.html">linear_spectral_analysis</a>();
end
% eigenvalues Lambda is sorted in descending order of real parts
% positive imaginary part is placed first in each complex pair

lambda = obj.System.spectrum.Lambda(resonant_modes);
lambdaRe = real(lambda);
lambdaIm = imag(lambda);
<a href="../../Library/SSM/private/check_spectrum_and_internal_resonance.html">check_spectrum_and_internal_resonance</a>(lambdaRe,lambdaIm,mFreqs);

%% SSM computation of autonomous part
obj.<a href="../../Library/Manifold/choose_E.html">choose_E</a>(resonant_modes)
% compute autonomous SSM coefficients
[W_0,R_0] = obj.<a href="../../Library/Manifold/compute_whisker.html">compute_whisker</a>(order);

% check reduced dynamics (consistent with expected internal resonance)
[beta,kappa] = <a href="../../Library/SSM/private/check_auto_reduced_dynamics.html">check_auto_reduced_dynamics</a>(R_0,order,mFreqs);

%% SSM computation of non-autonomous part
iNonauto = []; % indices for resonant happens
rNonauto = []; % value of leading order contribution
kNonauto = []; % (pos) kappa indices with resonance
kappa_set= [obj.System.Fext.data.kappa]; % each row corresponds to one kappa
kappa_pos = kappa_set(kappa_set>0);
num_kappa = numel(kappa_pos); % number of kappa pairs
for k=1:num_kappa
    kappak = kappa_pos(k);
    idm = find(mFreqs(:)==kappak); % idm could be vector if there are two frequencies are the same
    obj.System.Omega = lambdaIm(2*idm(1)-1);

    [W_1, R_1] = obj.<a href="../../Library/Manifold/compute_perturbed_whisker.html">compute_perturbed_whisker</a>(0,[],[]);

    idk = find(kappa_set==kappak);
    R_10 = R_1(idk).R.coeffs;
    r = R_10(2*idm-1);

    iNonauto = [iNonauto; idm];
    rNonauto = [rNonauto; r];
    kNonauto = [kNonauto; idk];
end
%% Construct COCO-compatible vector field
% create data to vector field
lamd  = struct();
lamd.lambdaRe = lambdaRe; lamd.lambdaIm = lambdaIm;
Nonauto = struct();
Nonauto.iNonauto = iNonauto; Nonauto.rNonauto = rNonauto; Nonauto.kNonauto = kNonauto;
[fdata,data_dir] = <a href="../../Library/SSM/private/create_reduced_dynamics_data.html">create_reduced_dynamics_data</a>(beta,kappa,lamd,mFreqs,Nonauto,W_0,W_1,order,resonant_modes);

ispolar = strcmp(obj.FRCOptions.coordinates, 'polar');
fdata.ispolar = ispolar;
fdata.isbaseForce = obj.System.Options.BaseExcitation;

if ispolar
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_polar.html">ode_2mDSSM_polar</a>(z,p,fdata);
else
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_cartesian.html">ode_2mDSSM_cartesian</a>(z,p,fdata);
end
funcs  = {odefun};
%
%% continuation of reduced dynamics w.r.t. parName
%
prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob);
% construct initial solution
if obj.System.order==2
    p0 = [obj.System.Omega; obj.System.fext.epsilon];
else
    p0 = [obj.System.Omega; obj.System.Fext.epsilon];
end
[p0,z0] = <a href="../../Library/SSM/private/initial_fixed_point.html">initial_fixed_point</a>(p0,obj.FRCOptions.initialSolver,ispolar,...
    odefun,nCycle,m,varargin{:});

% call ep-toolbox
prob = ode_isol2ep(prob, '', funcs{:}, z0, {'om' 'eps'}, p0);
% define monitor functions to state variables
[prob, args1, args2] = <a href="../../Library/SSM/private/monitor_states.html">monitor_states</a>(prob, ispolar, m);

switch parName
    case 'freq'
        isomega = true;
    case 'amp'
        isomega = false;
    otherwise
        error('Continuation parameter should be freq or amp');
end
if strcmp(obj.FRCOptions.sampStyle, 'uniform')
    if isomega
        omSamp = linspace(parRange(1),parRange(2), nPar);
        prob   = coco_add_event(prob, 'UZ', 'om', omSamp);
    else
        epSamp = linspace(parRange(1),parRange(2), nPar);
        prob   = coco_add_event(prob, 'UZ', 'eps', epSamp);
    end
end

runid = coco_get_id(oid, 'ep');

fprintf('\n Run=''%s'': Continue equilibria along primary branch.\n', ...
  runid);

if isomega
    cont_args = [{'om'},args1(:)' ,args2(:)',{'eps'}];
else
    cont_args = [{'eps'},args1(:)' ,args2(:)',{'om'}];
end

coco(prob, runid, [], 1, cont_args, parRange);

%% extract results of reduced dynamics at sampled frequencies
FRC = <a href="../../Library/SSM/private/ep_reduced_results.html">ep_reduced_results</a>(runid,obj.FRCOptions.sampStyle,ispolar,isomega,args1,args2);

%% FRC in physical domain
FRCdata = struct();        FRCdata.isomega = isomega;
FRCdata.mFreqs  = mFreqs;  FRCdata.order  = order;
FRCdata.ispolar = ispolar; FRCdata.modes  = resonant_modes;
FRC = FRC_<a href="../../Library/Features/misc/reduced_to_full.html">reduced_to_full</a>(obj,Nonauto,'ep',FRC,FRCdata,W_0,W_1,outdof,varargin{:});

% Plot Plot FRC in system coordinates
if isomega
    <a href="../../Library/SSM/private/plot_frc_full.html">plot_frc_full</a>(FRC.om,FRC.Znorm_frc,outdof,FRC.Aout_frc,FRC.st,order,'freq','lines',{FRC.SNidx,FRC.HBidx});
else
    <a href="../../Library/SSM/private/plot_frc_full.html">plot_frc_full</a>(FRC.ep,FRC.Znorm_frc,outdof,FRC.Aout_frc,FRC.st,order,'amp','lines',{FRC.SNidx,FRC.HBidx});
end

varargout{1} = FRC;
fdir = fullfile(data_dir,runid,'SSMep.mat');
save(fdir, 'FRC');
end

            ##### SOURCE END #####
        --></body></html></body></html>