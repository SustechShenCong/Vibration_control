
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><body><div class="banner"><a href="../../index.html"><img alt="Logo" class="logo" src="../../logo.png" style="float:right" width="200"/></a></div><html><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--

                    This HTML was auto-generated from MATLAB code.
                    To make changes, update the MATLAB code and republish this document.
                --><title>SSM_EPSWEEPS</title><meta content="MATLAB 9.14" name="generator"/><link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/><meta content="2023-09-09" name="DC.date"/><meta content="SSM_epSweeps.m" name="DC.source"/><style type="text/css">
            html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

            html { min-height:100%; margin-bottom:1px; }
            html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
            html body td { vertical-align:top; text-align:left; }

            h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
            h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
            h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

            a { color:#005fce; text-decoration:none; }
            a:hover { color:#005fce; text-decoration:underline; }
            a:visited { color:#004aa0; text-decoration:none; }

            p { padding:0px; margin:0px 0px 20px; }
            img { padding:0px; margin:0px 0px 20px; border:none; }
            p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

            ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
            ul li { padding:0px; margin:0px 0px 7px 0px; }
            ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
            ul li ol li { list-style:decimal; }
            ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
            ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
            ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
            ol li ol li { list-style-type:lower-alpha; }
            ol li ul { padding-top:7px; }
            ol li ul li { list-style:square; }

            .content { font-size:1.2em; line-height:140%; padding: 20px; }

            pre, code { font-size:12px; }
            tt { font-size: 1.2em; }
            pre { margin:0px 0px 20px; }
            pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
            pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
            pre.error { color:red; }

            @media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

            span.keyword { color:#0000FF }
            span.comment { color:#228B22 }
            span.string { color:#A020F0 }
            span.untermstring { color:#B20000 }
            span.syscmd { color:#B28C00 }
            span.typesection { color:#A0522D }

            .footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
            .footer p { margin:0px; }
            .footer a { color:#878787; }
            .footer a:hover { color:#878787; text-decoration:underline; }
            .footer a:visited { color:#878787; }

            table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
            table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }

            .center {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 50%;
              }



        </style></head><body><div class="content"><h1>SSM_EPSWEEPS</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">SSM_EPSWEEPS</a></li><li><a href="#3">Checking whether internal resonance indeed happens</a></li><li><a href="#4">SSM computation of autonomous part</a></li><li><a href="#5">SSM computation of non-autonomous part</a></li><li><a href="#6">Construct COCO-compatible vector field</a></li><li><a href="#7">continuation of reduced dynamics w.r.t. epsilon</a></li><li><a href="#8">a family of continuation of reduced dynamics w.r.t. Omega</a></li><li><a href="#9">results extraction</a></li><li><a href="#10">results in reduced system</a></li><li><a href="#11">results in physical domain</a></li><li><a href="#13">Visualization of results</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> varargout = SSM_epSweeps(obj,oid,resonant_modes,order,mFreqs,epSamp,omRange,outdof,varargin)
        </pre><h2 id="2">SSM_EPSWEEPS</h2><p>This function performs a family of continuation of equilibrium points of slow dynamics. In the first continuation run, forcing amplitude is changed and equilibria at sampled forcing frequencies will be lablled. Then continuation is performed with varied forcing frequency starting from each sampled equilibria. Note that equilibrium points in slow dynamics corresponds to a periodic orbit in the regular time dynamics. The continuation here starts from the guess of initial solution.</p><p>FRC = SSM_EPSWEEPS(OBJ,OID,MODES,ORDER,MFREQS,EPSAMPS,OMRANGE,OUTDOF,VARARGIN)</p><div><ul><li><tt>oid</tt>:      runid of continuation</li></ul></div><div><ul><li><tt>modes</tt>:    master spectral subspace</li></ul></div><div><ul><li><tt>order</tt>:    expansion order of SSM</li></ul></div><div><ul><li><tt>mFreqs</tt>:   internal resonance relation vector</li></ul></div><div><ul><li><tt>epSamp</tt>:   sampled forcing amplitudes for forced response curves</li></ul></div><div><ul><li><tt>omRange</tt>:  continuation domain of forcing frequency, which should be near the           value of natural frequency with index 1</li></ul></div><div><ul><li><tt>outdof</tt>:   output for dof in physical domain</li></ul></div><div><ul><li><tt>varargin</tt>: [{p0,z0}], ['saveICs'] where {p0,z0} are initial solution           guesses and saveICs is a flag saving a point on trajectory as initial           condition for numerical integration</li></ul></div><pre class="codeinput">m = numel(mFreqs);
assert(numel(resonant_modes)==2*m, <span class="string">'The master subspace is not %dD.'</span>,2*m);
nOmega = obj.FRCOptions.nPar;
nCycle = obj.FRCOptions.nCycle;
        </pre><h2 id="3">Checking whether internal resonance indeed happens</h2><pre class="codeinput"><span class="keyword">if</span> isempty(obj.System.spectrum)
    [~,~,~] = obj.System.<a href="../../Library/DynamicalSystem/linear_spectral_analysis.html">linear_spectral_analysis</a>();
<span class="keyword">end</span>
<span class="comment">% eigenvalues Lambda is sorted in descending order of real parts</span>
<span class="comment">% positive imaginary part is placed first in each complex pair</span>

lambda = obj.System.spectrum.Lambda(resonant_modes);
lambdaRe = real(lambda);
lambdaIm = imag(lambda);
<a href="../../Library/SSM/private/check_spectrum_and_internal_resonance.html">check_spectrum_and_internal_resonance</a>(lambdaRe,lambdaIm,mFreqs);
        </pre><h2 id="4">SSM computation of autonomous part</h2><pre class="codeinput">obj.<a href="../../Library/Manifold/choose_E.html">choose_E</a>(resonant_modes)
<span class="comment">% compute autonomous SSM coefficients</span>
[W_0,R_0] = obj.<a href="../../Library/Manifold/compute_whisker.html">compute_whisker</a>(order);

<span class="comment">% check reduced dynamics to see its consistent with reduced dynamics</span>
[beta,kappa] = <a href="../../Library/SSM/private/check_auto_reduced_dynamics.html">check_auto_reduced_dynamics</a>(R_0,order,mFreqs);
        </pre><h2 id="5">SSM computation of non-autonomous part</h2><pre class="codeinput">iNonauto = []; <span class="comment">% indices for resonant happens</span>
rNonauto = []; <span class="comment">% value of leading order contribution</span>
kNonauto = []; <span class="comment">% (pos) kappa indices with resonance</span>
kappa_set= [obj.System.Fext.data.kappa]; <span class="comment">% each row corresponds to one kappa</span>
kappa_pos = kappa_set(kappa_set&gt;0);
num_kappa = numel(kappa_pos); <span class="comment">% number of kappa pairs</span>
<span class="keyword">for</span> k=1:num_kappa
    kappak = kappa_pos(k);
    idm = find(mFreqs(:)==kappak); <span class="comment">% idm could be vector if there are two frequencies are the same</span>
    obj.System.Omega = lambdaIm(2*idm(1)-1);

    [W_1, R_1] = obj.<a href="../../Library/Manifold/compute_perturbed_whisker.html">compute_perturbed_whisker</a>(0,[],[]);

    idk = find(kappa_set==kappak);
    R_10 = R_1(idk).R.coeffs;
    r = R_10(2*idm-1);

    iNonauto = [iNonauto; idm];
    rNonauto = [rNonauto; r];
    kNonauto = [kNonauto; idk];
<span class="keyword">end</span>
        </pre><h2 id="6">Construct COCO-compatible vector field</h2><pre class="codeinput">lamd  = struct();
lamd.lambdaRe = lambdaRe; lamd.lambdaIm = lambdaIm;
Nonauto = struct();
Nonauto.iNonauto = iNonauto; Nonauto.rNonauto = rNonauto; Nonauto.kNonauto = kNonauto;
[fdata,~] = <a href="../../Library/SSM/private/create_reduced_dynamics_data.html">create_reduced_dynamics_data</a>(beta,kappa,lamd,mFreqs,Nonauto,W_0,W_1,order,resonant_modes);

ispolar = strcmp(obj.FRCOptions.coordinates, <span class="string">'polar'</span>);
fdata.ispolar = ispolar;
fdata.isbaseForce = obj.System.Options.BaseExcitation;

<span class="keyword">if</span> ispolar
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_polar.html">ode_2mDSSM_polar</a>(z,p,fdata);
<span class="keyword">else</span>
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_cartesian.html">ode_2mDSSM_cartesian</a>(z,p,fdata);
<span class="keyword">end</span>
funcs  = {odefun};
<span class="comment">%</span>
        </pre><h2 id="7">continuation of reduced dynamics w.r.t. epsilon</h2><pre class="codeinput">prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob);
<span class="comment">% construct initial solution</span>
<span class="keyword">if</span> obj.System.order==2
    p0 = [obj.System.Omega; obj.System.fext.epsilon];
<span class="keyword">else</span>
    p0 = [obj.System.Omega; obj.System.Fext.epsilon];
<span class="keyword">end</span>
[p0,z0] = <a href="../../Library/SSM/private/initial_fixed_point.html">initial_fixed_point</a>(p0,obj.FRCOptions.initialSolver,ispolar,<span class="keyword">...</span>
    odefun,nCycle,m,varargin{:});
<span class="comment">% call ep-toolbox</span>
prob = ode_isol2ep(prob, <span class="string">''</span>, funcs{:}, z0, {<span class="string">'om'</span> <span class="string">'eps'</span>}, p0);
<span class="comment">% define monitor functions to state variables</span>
[prob, args1, args2] = <a href="../../Library/SSM/private/monitor_states.html">monitor_states</a>(prob, ispolar, m);
prob  = coco_add_event(prob, <span class="string">'UZ'</span>, <span class="string">'eps'</span>, epSamp); <span class="comment">% label epSamp with UZ</span>
runid = [oid, <span class="string">'eps'</span>];
runid = coco_get_id(runid, <span class="string">'ep'</span>);
fprintf(<span class="string">'\n Run=''%s'': Continue equilibria with varied epsilon.\n'</span>, <span class="keyword">...</span>
  runid);
cont_args = [{<span class="string">'eps'</span>},args1(:)' ,args2(:)',{<span class="string">'om'</span>}];
coco(prob, runid, [], 1, cont_args, [0.9*min(epSamp) 1.1*max(epSamp)]);
        </pre><h2 id="8">a family of continuation of reduced dynamics w.r.t. Omega</h2><pre class="codeinput">bd = coco_bd_read(runid);
sampLabs = coco_bd_labs(bd, <span class="string">'UZ'</span>);
numLabs  = numel(sampLabs);
<span class="keyword">if</span> numLabs~=numel(epSamp)
    warning(<span class="string">'The number of sampled forcing amplitude is not the same as requested.'</span>);
<span class="keyword">end</span>
ep   = coco_bd_vals(bd, sampLabs, <span class="string">'eps'</span>);
Labs  = zeros(numLabs,1);

<span class="keyword">for</span> k=1:numLabs
    epk     = epSamp(k);
    [~,id]  = min(abs(ep-epk));
    Labs(k) = id;
    prob = coco_prob();
    prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions,prob);
    prob = ode_ep2ep(prob, <span class="string">''</span>, runid, sampLabs(id));

    <span class="keyword">if</span> strcmp(obj.FRCOptions.sampStyle, <span class="string">'uniform'</span>)
        omSamp = linspace(omRange(1),omRange(2), nOmega);
        prob   = coco_add_event(prob, <span class="string">'UZ'</span>, <span class="string">'om'</span>, omSamp);
    <span class="keyword">end</span>

    [prob, args1, args2] = <a href="../../Library/SSM/private/monitor_states.html">monitor_states</a>(prob, ispolar, m);
    cont_args = [{<span class="string">'om'</span>},args1(:)' ,args2(:)',{<span class="string">'eps'</span>}];
    runidk = [oid,<span class="string">'eps'</span>,num2str(k)];
    runidk = coco_get_id(runidk, <span class="string">'ep'</span>);

    fprintf(<span class="string">'\n Run=''%s'': Continue equilibria with varied omega at eps equal to %d.\n'</span>, <span class="keyword">...</span>
      runidk, ep(id));

    coco(prob, runidk, [], 1, cont_args, omRange);
<span class="keyword">end</span>
        </pre><h2 id="9">results extraction</h2><pre class="codeinput">FRCom = cell(numLabs,1);
FRCdata = struct();        FRCdata.isomega = true;
FRCdata.mFreqs  = mFreqs;  FRCdata.order  = order;
FRCdata.ispolar = ispolar; FRCdata.modes  = resonant_modes;
<span class="keyword">for</span> k=1:numLabs
        </pre><h2 id="10">results in reduced system</h2><pre class="codeinput">    runidk = [oid,<span class="string">'eps'</span>,num2str(k)];
    runidk = coco_get_id(runidk, <span class="string">'ep'</span>);
    FRC = <a href="../../Library/SSM/private/ep_reduced_results.html">ep_reduced_results</a>(runidk,obj.FRCOptions.sampStyle,ispolar,true,args1,args2,<span class="string">'plot-off'</span>);
        </pre><h2 id="11">results in physical domain</h2><pre class="codeinput">    <span class="keyword">if</span> ~isempty(outdof)
    fprintf(<span class="string">'Calculate FRC in physical domain at epsilon %d\n'</span>, ep(Labs(k)));
    FRC = FRC_<a href="../../Library/Features/misc/reduced_to_full.html">reduced_to_full</a>(obj,Nonauto,<span class="string">'ep'</span>,FRC,FRCdata,W_0,W_1,outdof,varargin{:});
    <span class="keyword">end</span>
    FRCom{k} = FRC;
        </pre><pre class="codeinput"><span class="keyword">end</span>

<span class="comment">% save results</span>
FRC = struct();
FRC.SSMorder   = order;
FRC.SSMnonAuto = obj.Options.contribNonAuto;
FRC.SSMispolar = ispolar;
FRC.FRCom = FRCom;
FRC.eps = ep(Labs);
varargout{1} = FRC;
fdir = fullfile(pwd,<span class="string">'data'</span>,runid,<span class="string">'SSMep.mat'</span>);
save(fdir, <span class="string">'FRC'</span>);
        </pre><h2 id="13">Visualization of results</h2><pre class="codeinput">sweeps_plot(m,ispolar,numLabs,oid,FRCom,outdof,order);
        </pre><pre class="codeinput"><span class="keyword">end</span>
        </pre><pre class="codeinput"><span class="keyword">function</span> sweeps_plot(m,ispolar,numLabs,oid,FRCom,outdof,order)
<span class="comment">% Plot FRC in normal coordinates</span>
thm = struct( <span class="string">'special'</span>, {{<span class="string">'SN'</span>, <span class="string">'HB'</span>}});
thm.SN = {<span class="string">'LineStyle'</span>, <span class="string">'none'</span>, <span class="string">'LineWidth'</span>, 2, <span class="keyword">...</span>
  <span class="string">'Color'</span>, <span class="string">'cyan'</span>, <span class="string">'Marker'</span>, <span class="string">'o'</span>, <span class="string">'MarkerSize'</span>, 8, <span class="string">'MarkerEdgeColor'</span>, <span class="keyword">...</span>
  <span class="string">'cyan'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'white'</span>};
thm.HB = {<span class="string">'LineStyle'</span>, <span class="string">'none'</span>, <span class="string">'LineWidth'</span>, 2, <span class="keyword">...</span>
  <span class="string">'Color'</span>, <span class="string">'black'</span>, <span class="string">'Marker'</span>, <span class="string">'s'</span>, <span class="string">'MarkerSize'</span>, 8, <span class="string">'MarkerEdgeColor'</span>, <span class="keyword">...</span>
  <span class="string">'black'</span>, <span class="string">'MarkerFaceColor'</span>, <span class="string">'white'</span>};

<span class="keyword">for</span> i=1:m
    <span class="comment">% 2D plot</span>
    figure;
    <span class="keyword">if</span> ispolar
        rhoi = strcat(<span class="string">'rho'</span>,num2str(i));
        <span class="keyword">for</span> k=1:numLabs
            runidk = [oid,<span class="string">'eps'</span>,num2str(k)];
            runidk = coco_get_id(runidk, <span class="string">'ep'</span>);
            coco_plot_bd(thm, runidk, <span class="string">'om'</span>, rhoi, @(x) abs(x)); hold <span class="string">on</span>
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        Rezi = strcat(<span class="string">'Rez'</span>,num2str(i));
        Imzi = strcat(<span class="string">'Imz'</span>,num2str(i));
        <span class="keyword">for</span> k=1:numLabs
            runidk = [oid,<span class="string">'eps'</span>,num2str(k)];
            runidk = coco_get_id(runidk, <span class="string">'ep'</span>);
            coco_plot_bd(thm, runidk, <span class="string">'om'</span>, {Rezi,Imzi}, @(x,y) sqrt(x.^2+y.^2)); hold <span class="string">on</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    grid <span class="string">on</span>; box <span class="string">on</span>; axis <span class="string">tight</span>
    set(gca,<span class="string">'LineWidth'</span>,1.2);
    set(gca,<span class="string">'FontSize'</span>,14);
    xlabel(<span class="string">'$\Omega$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
    ylabel(strcat(<span class="string">'$\rho_'</span>,num2str(i),<span class="string">'$'</span>),<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
    <span class="comment">% 3D plot</span>
    figure;
    <span class="keyword">if</span> ispolar
        rhoi = strcat(<span class="string">'rho'</span>,num2str(i));
        <span class="keyword">for</span> k=1:numLabs
            runidk = [oid,<span class="string">'eps'</span>,num2str(k)];
            runidk = coco_get_id(runidk, <span class="string">'ep'</span>);
            coco_plot_bd(thm, runidk, <span class="string">'om'</span>, <span class="string">'eps'</span>, rhoi, @(x) abs(x)); hold <span class="string">on</span>
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        Rezi = strcat(<span class="string">'Rez'</span>,num2str(i));
        Imzi = strcat(<span class="string">'Imz'</span>,num2str(i));
        <span class="keyword">for</span> k=1:numLabs
            runidk = [oid,<span class="string">'eps'</span>,num2str(k)];
            runidk = coco_get_id(runidk, <span class="string">'ep'</span>);
            coco_plot_bd(thm, runidk, <span class="string">'om'</span>, <span class="string">'eps'</span>, {Rezi,Imzi}, @(x,y) sqrt(x.^2+y.^2)); hold <span class="string">on</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    grid <span class="string">on</span>; box <span class="string">on</span>; axis <span class="string">tight</span>
    set(gca,<span class="string">'LineWidth'</span>,1.2);
    set(gca,<span class="string">'FontSize'</span>,14);
    xlabel(<span class="string">'$\Omega$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
    ylabel(<span class="string">'$\epsilon$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
    zlabel(strcat(<span class="string">'$\rho_'</span>,num2str(i),<span class="string">'$'</span>),<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
<span class="keyword">end</span>

<span class="comment">% Plot FRC in system coordinates</span>
<span class="comment">% setup legend</span>
legTypes = zeros(numLabs,1); <span class="comment">% each entry can be 1/2/3 - all stab/all unstab/mix</span>
<span class="keyword">for</span> k=1:numLabs
   stab = FRCom{k}.st;
   <span class="keyword">if</span> all(stab)
       legTypes(k) = 1;
   <span class="keyword">elseif</span> all(~stab)
       legTypes(k) = 2;
   <span class="keyword">else</span>
       legTypes(k) = 3;
   <span class="keyword">end</span>
<span class="keyword">end</span>
legDisp = []; <span class="comment">% figure with legends displayed</span>
idmix = find(legTypes==3);
<span class="keyword">if</span> ~isempty(idmix)
    legDisp = [legDisp idmix(1)];
<span class="keyword">else</span>
    idallstab = find(legTypes==1);
    <span class="keyword">if</span> ~isempty(idallstab)
        legDisp = [legDisp,idallstab(1)];
    <span class="keyword">end</span>
    idallunstab = find(legTypes==2);
    <span class="keyword">if</span> ~isempty(idallunstab)
        legDisp = [legDisp,idallunstab(1)];
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">if</span> ~isempty(outdof)
ndof = numel(outdof);
<span class="keyword">for</span> i=1:ndof
    <span class="comment">% 2D plot</span>
    figure; hold <span class="string">on</span>
    <span class="keyword">for</span> k=1:numLabs
        om = FRCom{k}.om;
        Aout = FRCom{k}.Aout_<a href="../../Library/Features/frc/frc.html">frc</a>(:,i);
        stab = FRCom{k}.st;
        <span class="keyword">if</span> any(legDisp==k)
            <a href="../../Library/Features/misc/stab_plot.html">stab_plot</a>(om,Aout,stab,order,<span class="string">'blue'</span>);
        <span class="keyword">else</span>
            <a href="../../Library/Features/misc/stab_plot.html">stab_plot</a>(om,Aout,stab,order,<span class="string">'blue'</span>,<span class="string">'nolegends'</span>);
        <span class="keyword">end</span>
        <span class="comment">% plot special points</span>
        SNidx = FRCom{k}.SNidx;
        SNfig = plot(om(SNidx),Aout(SNidx),thm.SN{:});
        set(get(get(SNfig,<span class="string">'Annotation'</span>),<span class="string">'LegendInformation'</span>),<span class="keyword">...</span>
            <span class="string">'IconDisplayStyle'</span>,<span class="string">'off'</span>);
        HBidx = FRCom{k}.HBidx;
        HBfig = plot(om(HBidx),Aout(HBidx),thm.HB{:});
        set(get(get(HBfig,<span class="string">'Annotation'</span>),<span class="string">'LegendInformation'</span>),<span class="keyword">...</span>
            <span class="string">'IconDisplayStyle'</span>,<span class="string">'off'</span>);
    <span class="keyword">end</span>
    xlabel(<span class="string">'$\Omega$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
    zk = strcat(<span class="string">'$||z_{'</span>,num2str(outdof(i)),<span class="string">'}||_{\infty}$'</span>);
    ylabel(zk,<span class="string">'Interpreter'</span>,<span class="string">'latex'</span>);
    set(gca,<span class="string">'FontSize'</span>,14);
    grid <span class="string">on</span>, axis <span class="string">tight</span>; legend <span class="string">boxoff</span>;

    <span class="comment">% 3D plot</span>
    figure; hold <span class="string">on</span>
    <span class="keyword">for</span> k=1:numLabs
        om = FRCom{k}.om;
        epsf = FRCom{k}.ep;
        Aout = FRCom{k}.Aout_<a href="../../Library/Features/frc/frc.html">frc</a>(:,i);
        stab = FRCom{k}.st;
        <span class="keyword">if</span> any(legDisp==k)
            <a href="../../Library/SSM/private/stab_plot3.html">stab_plot3</a>(om,epsf,Aout,stab,order);
        <span class="keyword">else</span>
            <a href="../../Library/SSM/private/stab_plot3.html">stab_plot3</a>(om,epsf,Aout,stab,order,<span class="string">'nolegends'</span>);
        <span class="keyword">end</span>
        <span class="comment">% plot special points</span>
        SNidx = FRCom{k}.SNidx;
        SNfig = plot3(om(SNidx),epsf(SNidx),Aout(SNidx),thm.SN{:});
        set(get(get(SNfig,<span class="string">'Annotation'</span>),<span class="string">'LegendInformation'</span>),<span class="keyword">...</span>
            <span class="string">'IconDisplayStyle'</span>,<span class="string">'off'</span>);
        HBidx = FRCom{k}.HBidx;
        HBfig = plot3(om(HBidx),epsf(HBidx),Aout(HBidx),thm.HB{:});
        set(get(get(HBfig,<span class="string">'Annotation'</span>),<span class="string">'LegendInformation'</span>),<span class="keyword">...</span>
            <span class="string">'IconDisplayStyle'</span>,<span class="string">'off'</span>);
    <span class="keyword">end</span>
    xlabel(<span class="string">'$\Omega$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
    ylabel(<span class="string">'$\epsilon$'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>,<span class="string">'FontSize'</span>,16);
    zk = strcat(<span class="string">'$||z_{'</span>,num2str(outdof(i)),<span class="string">'}||_{\infty}$'</span>);
    zlabel(zk,<span class="string">'Interpreter'</span>,<span class="string">'latex'</span>);
    set(gca,<span class="string">'FontSize'</span>,14);
    grid <span class="string">on</span>, axis <span class="string">tight</span>; legend <span class="string">boxoff</span>;
    view([-1,-1,1]);
<span class="keyword">end</span>

<span class="keyword">end</span>
<span class="keyword">end</span>
        </pre><p class="footer"><br/><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB® R2023a</a><br/></p></div><!--
            ##### SOURCE BEGIN #####
            %% SSM_EPSWEEPS
%
%%
function varargout = SSM_epSweeps(obj,oid,resonant_modes,order,mFreqs,epSamp,omRange,outdof,varargin)
%% SSM_EPSWEEPS 
% This function performs a family of continuation of 
% equilibrium points of slow dynamics. In the first continuation run,
% forcing amplitude is changed and equilibria at sampled forcing
% frequencies will be lablled. Then continuation is performed with varied
% forcing frequency starting from each sampled equilibria. Note that
% equilibrium points in slow dynamics corresponds to a periodic orbit in
% the regular time dynamics. The continuation here starts from the guess of
% initial solution. 
%
% FRC = SSM_EPSWEEPS(OBJ,OID,MODES,ORDER,MFREQS,EPSAMPS,OMRANGE,OUTDOF,VARARGIN)
%
% * |oid|:      runid of continuation
% 
% * |modes|:    master spectral subspace
% 
% * |order|:    expansion order of SSM
% 
% * |mFreqs|:   internal resonance relation vector
% 
% * |epSamp|:   sampled forcing amplitudes for forced response curves
% 
% * |omRange|:  continuation domain of forcing frequency, which should be near the
%           value of natural frequency with index 1
% 
% * |outdof|:   output for dof in physical domain
% 
% * |varargin|: [{p0,z0}], ['saveICs'] where {p0,z0} are initial solution
%           guesses and saveICs is a flag saving a point on trajectory as initial
%           condition for numerical integration

m = numel(mFreqs);
assert(numel(resonant_modes)==2*m, 'The master subspace is not %dD.',2*m);
nOmega = obj.FRCOptions.nPar;
nCycle = obj.FRCOptions.nCycle;
%% Checking whether internal resonance indeed happens
if isempty(obj.System.spectrum)
    [~,~,~] = obj.System.<a href="../../Library/DynamicalSystem/linear_spectral_analysis.html">linear_spectral_analysis</a>();
end
% eigenvalues Lambda is sorted in descending order of real parts
% positive imaginary part is placed first in each complex pair

lambda = obj.System.spectrum.Lambda(resonant_modes);
lambdaRe = real(lambda);
lambdaIm = imag(lambda);
<a href="../../Library/SSM/private/check_spectrum_and_internal_resonance.html">check_spectrum_and_internal_resonance</a>(lambdaRe,lambdaIm,mFreqs);

%% SSM computation of autonomous part
obj.<a href="../../Library/Manifold/choose_E.html">choose_E</a>(resonant_modes)
% compute autonomous SSM coefficients
[W_0,R_0] = obj.<a href="../../Library/Manifold/compute_whisker.html">compute_whisker</a>(order);

% check reduced dynamics to see its consistent with reduced dynamics
[beta,kappa] = <a href="../../Library/SSM/private/check_auto_reduced_dynamics.html">check_auto_reduced_dynamics</a>(R_0,order,mFreqs);

%% SSM computation of non-autonomous part
iNonauto = []; % indices for resonant happens
rNonauto = []; % value of leading order contribution
kNonauto = []; % (pos) kappa indices with resonance
kappa_set= [obj.System.Fext.data.kappa]; % each row corresponds to one kappa
kappa_pos = kappa_set(kappa_set>0);
num_kappa = numel(kappa_pos); % number of kappa pairs
for k=1:num_kappa
    kappak = kappa_pos(k);
    idm = find(mFreqs(:)==kappak); % idm could be vector if there are two frequencies are the same
    obj.System.Omega = lambdaIm(2*idm(1)-1);
    
    [W_1, R_1] = obj.<a href="../../Library/Manifold/compute_perturbed_whisker.html">compute_perturbed_whisker</a>(0,[],[]);

    idk = find(kappa_set==kappak);
    R_10 = R_1(idk).R.coeffs;
    r = R_10(2*idm-1);    
    
    iNonauto = [iNonauto; idm];
    rNonauto = [rNonauto; r];  
    kNonauto = [kNonauto; idk];
end
%% Construct COCO-compatible vector field 
lamd  = struct(); 
lamd.lambdaRe = lambdaRe; lamd.lambdaIm = lambdaIm;
Nonauto = struct();
Nonauto.iNonauto = iNonauto; Nonauto.rNonauto = rNonauto; Nonauto.kNonauto = kNonauto;
[fdata,~] = <a href="../../Library/SSM/private/create_reduced_dynamics_data.html">create_reduced_dynamics_data</a>(beta,kappa,lamd,mFreqs,Nonauto,W_0,W_1,order,resonant_modes);

ispolar = strcmp(obj.FRCOptions.coordinates, 'polar');
fdata.ispolar = ispolar;
fdata.isbaseForce = obj.System.Options.BaseExcitation;

if ispolar
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_polar.html">ode_2mDSSM_polar</a>(z,p,fdata);
else
    odefun = @(z,p) <a href="../../Library/SSM/private/ode_2mDSSM_cartesian.html">ode_2mDSSM_cartesian</a>(z,p,fdata);
end
funcs  = {odefun};
% 
%% continuation of reduced dynamics w.r.t. epsilon
prob = coco_prob();
prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions, prob);
% construct initial solution
if obj.System.order==2
    p0 = [obj.System.Omega; obj.System.fext.epsilon];
else
    p0 = [obj.System.Omega; obj.System.Fext.epsilon];
end
[p0,z0] = <a href="../../Library/SSM/private/initial_fixed_point.html">initial_fixed_point</a>(p0,obj.FRCOptions.initialSolver,ispolar,...
    odefun,nCycle,m,varargin{:});
% call ep-toolbox
prob = ode_isol2ep(prob, '', funcs{:}, z0, {'om' 'eps'}, p0);
% define monitor functions to state variables
[prob, args1, args2] = <a href="../../Library/SSM/private/monitor_states.html">monitor_states</a>(prob, ispolar, m);
prob  = coco_add_event(prob, 'UZ', 'eps', epSamp); % label epSamp with UZ
runid = [oid, 'eps'];
runid = coco_get_id(runid, 'ep');
fprintf('\n Run=''%s'': Continue equilibria with varied epsilon.\n', ...
  runid);
cont_args = [{'eps'},args1(:)' ,args2(:)',{'om'}];
coco(prob, runid, [], 1, cont_args, [0.9*min(epSamp) 1.1*max(epSamp)]);

%% a family of continuation of reduced dynamics w.r.t. Omega
bd = coco_bd_read(runid);
sampLabs = coco_bd_labs(bd, 'UZ'); 
numLabs  = numel(sampLabs);
if numLabs~=numel(epSamp)
    warning('The number of sampled forcing amplitude is not the same as requested.');
end
ep   = coco_bd_vals(bd, sampLabs, 'eps');
Labs  = zeros(numLabs,1);

for k=1:numLabs
    epk     = epSamp(k);
    [~,id]  = min(abs(ep-epk));
    Labs(k) = id;
    prob = coco_prob();
    prob = <a href="../../Library/Features/Wrappers/cocoWrapper/cocoSet.html">cocoSet</a>(obj.contOptions,prob);
    prob = ode_ep2ep(prob, '', runid, sampLabs(id));
    
    if strcmp(obj.FRCOptions.sampStyle, 'uniform')
        omSamp = linspace(omRange(1),omRange(2), nOmega);
        prob   = coco_add_event(prob, 'UZ', 'om', omSamp);
    end
    
    [prob, args1, args2] = <a href="../../Library/SSM/private/monitor_states.html">monitor_states</a>(prob, ispolar, m);
    cont_args = [{'om'},args1(:)' ,args2(:)',{'eps'}];
    runidk = [oid,'eps',num2str(k)];
    runidk = coco_get_id(runidk, 'ep');

    fprintf('\n Run=''%s'': Continue equilibria with varied omega at eps equal to %d.\n', ...
      runidk, ep(id));
  
    coco(prob, runidk, [], 1, cont_args, omRange);
end        

%% results extraction
FRCom = cell(numLabs,1);
FRCdata = struct();        FRCdata.isomega = true; 
FRCdata.mFreqs  = mFreqs;  FRCdata.order  = order; 
FRCdata.ispolar = ispolar; FRCdata.modes  = resonant_modes;
for k=1:numLabs
    %% results in reduced system
    runidk = [oid,'eps',num2str(k)];
    runidk = coco_get_id(runidk, 'ep');
    FRC = <a href="../../Library/SSM/private/ep_reduced_results.html">ep_reduced_results</a>(runidk,obj.FRCOptions.sampStyle,ispolar,true,args1,args2,'plot-off');
    %% results in physical domain
    if ~isempty(outdof)
    fprintf('Calculate FRC in physical domain at epsilon %d\n', ep(Labs(k)));
    FRC = FRC_<a href="../../Library/Features/misc/reduced_to_full.html">reduced_to_full</a>(obj,Nonauto,'ep',FRC,FRCdata,W_0,W_1,outdof,varargin{:});
    end
    FRCom{k} = FRC;
end

% save results
FRC = struct();
FRC.SSMorder   = order;
FRC.SSMnonAuto = obj.Options.contribNonAuto;
FRC.SSMispolar = ispolar;
FRC.FRCom = FRCom;
FRC.eps = ep(Labs);
varargout{1} = FRC;
fdir = fullfile(pwd,'data',runid,'SSMep.mat');
save(fdir, 'FRC');

%% Visualization of results
sweeps_plot(m,ispolar,numLabs,oid,FRCom,outdof,order);
end



%%
%
function sweeps_plot(m,ispolar,numLabs,oid,FRCom,outdof,order)
% Plot FRC in normal coordinates
thm = struct( 'special', {{'SN', 'HB'}});
thm.SN = {'LineStyle', 'none', 'LineWidth', 2, ...
  'Color', 'cyan', 'Marker', 'o', 'MarkerSize', 8, 'MarkerEdgeColor', ...
  'cyan', 'MarkerFaceColor', 'white'};
thm.HB = {'LineStyle', 'none', 'LineWidth', 2, ...
  'Color', 'black', 'Marker', 's', 'MarkerSize', 8, 'MarkerEdgeColor', ...
  'black', 'MarkerFaceColor', 'white'};

for i=1:m
    % 2D plot
    figure;
    if ispolar
        rhoi = strcat('rho',num2str(i));
        for k=1:numLabs
            runidk = [oid,'eps',num2str(k)];
            runidk = coco_get_id(runidk, 'ep');
            coco_plot_bd(thm, runidk, 'om', rhoi, @(x) abs(x)); hold on
        end
    else
        Rezi = strcat('Rez',num2str(i));
        Imzi = strcat('Imz',num2str(i));
        for k=1:numLabs
            runidk = [oid,'eps',num2str(k)];
            runidk = coco_get_id(runidk, 'ep');
            coco_plot_bd(thm, runidk, 'om', {Rezi,Imzi}, @(x,y) sqrt(x.^2+y.^2)); hold on
        end              
    end
    grid on; box on; axis tight
    set(gca,'LineWidth',1.2);
    set(gca,'FontSize',14);
    xlabel('$\Omega$','interpreter','latex','FontSize',16);
    ylabel(strcat('$\rho_',num2str(i),'$'),'interpreter','latex','FontSize',16);
    % 3D plot
    figure;
    if ispolar
        rhoi = strcat('rho',num2str(i));
        for k=1:numLabs
            runidk = [oid,'eps',num2str(k)];
            runidk = coco_get_id(runidk, 'ep');
            coco_plot_bd(thm, runidk, 'om', 'eps', rhoi, @(x) abs(x)); hold on
        end
    else
        Rezi = strcat('Rez',num2str(i));
        Imzi = strcat('Imz',num2str(i));
        for k=1:numLabs
            runidk = [oid,'eps',num2str(k)];
            runidk = coco_get_id(runidk, 'ep');
            coco_plot_bd(thm, runidk, 'om', 'eps', {Rezi,Imzi}, @(x,y) sqrt(x.^2+y.^2)); hold on
        end              
    end
    grid on; box on; axis tight
    set(gca,'LineWidth',1.2);
    set(gca,'FontSize',14);
    xlabel('$\Omega$','interpreter','latex','FontSize',16);
    ylabel('$\epsilon$','interpreter','latex','FontSize',16);
    zlabel(strcat('$\rho_',num2str(i),'$'),'interpreter','latex','FontSize',16);    
end

% Plot FRC in system coordinates
% setup legend
legTypes = zeros(numLabs,1); % each entry can be 1/2/3 - all stab/all unstab/mix
for k=1:numLabs
   stab = FRCom{k}.st;
   if all(stab)
       legTypes(k) = 1;
   elseif all(~stab)
       legTypes(k) = 2;
   else
       legTypes(k) = 3;
   end
end
legDisp = []; % figure with legends displayed
idmix = find(legTypes==3);
if ~isempty(idmix)
    legDisp = [legDisp idmix(1)];
else
    idallstab = find(legTypes==1);
    if ~isempty(idallstab)
        legDisp = [legDisp,idallstab(1)];
    end
    idallunstab = find(legTypes==2);
    if ~isempty(idallunstab)
        legDisp = [legDisp,idallunstab(1)];
    end
end

if ~isempty(outdof)
ndof = numel(outdof);
for i=1:ndof
    % 2D plot
    figure; hold on
    for k=1:numLabs
        om = FRCom{k}.om;
        Aout = FRCom{k}.Aout_<a href="../../Library/Features/frc/frc.html">frc</a>(:,i);
        stab = FRCom{k}.st;
        if any(legDisp==k)
            <a href="../../Library/Features/misc/stab_plot.html">stab_plot</a>(om,Aout,stab,order,'blue');
        else
            <a href="../../Library/Features/misc/stab_plot.html">stab_plot</a>(om,Aout,stab,order,'blue','nolegends');
        end
        % plot special points
        SNidx = FRCom{k}.SNidx;
        SNfig = plot(om(SNidx),Aout(SNidx),thm.SN{:});
        set(get(get(SNfig,'Annotation'),'LegendInformation'),...
            'IconDisplayStyle','off');
        HBidx = FRCom{k}.HBidx;
        HBfig = plot(om(HBidx),Aout(HBidx),thm.HB{:});
        set(get(get(HBfig,'Annotation'),'LegendInformation'),...
            'IconDisplayStyle','off');         
    end    
    xlabel('$\Omega$','interpreter','latex','FontSize',16);
    zk = strcat('$||z_{',num2str(outdof(i)),'}||_{\infty}$');
    ylabel(zk,'Interpreter','latex');
    set(gca,'FontSize',14);
    grid on, axis tight; legend boxoff;
    
    % 3D plot
    figure; hold on
    for k=1:numLabs
        om = FRCom{k}.om;
        epsf = FRCom{k}.ep;
        Aout = FRCom{k}.Aout_<a href="../../Library/Features/frc/frc.html">frc</a>(:,i);
        stab = FRCom{k}.st;
        if any(legDisp==k)
            <a href="../../Library/SSM/private/stab_plot3.html">stab_plot3</a>(om,epsf,Aout,stab,order);
        else
            <a href="../../Library/SSM/private/stab_plot3.html">stab_plot3</a>(om,epsf,Aout,stab,order,'nolegends');
        end
        % plot special points
        SNidx = FRCom{k}.SNidx;
        SNfig = plot3(om(SNidx),epsf(SNidx),Aout(SNidx),thm.SN{:});
        set(get(get(SNfig,'Annotation'),'LegendInformation'),...
            'IconDisplayStyle','off');
        HBidx = FRCom{k}.HBidx;
        HBfig = plot3(om(HBidx),epsf(HBidx),Aout(HBidx),thm.HB{:});
        set(get(get(HBfig,'Annotation'),'LegendInformation'),...
            'IconDisplayStyle','off');        
    end
    xlabel('$\Omega$','interpreter','latex','FontSize',16);
    ylabel('$\epsilon$','interpreter','latex','FontSize',16);
    zk = strcat('$||z_{',num2str(outdof(i)),'}||_{\infty}$');
    zlabel(zk,'Interpreter','latex');
    set(gca,'FontSize',14);
    grid on, axis tight; legend boxoff;
    view([-1,-1,1]);
end

end
end



            ##### SOURCE END #####
        --></body></html></body></html>