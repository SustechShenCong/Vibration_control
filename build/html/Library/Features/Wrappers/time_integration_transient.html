
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html><body><div class="banner"><a href="../../../index.html"><img alt="Logo" class="logo" src="../../../logo.png" style="float:right" width="200"/></a></div><html><head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--

                    This HTML was auto-generated from MATLAB code.
                    To make changes, update the MATLAB code and republish this document.
                --><title>Time integration of transient response</title><meta content="MATLAB 9.14" name="generator"/><link href="http://purl.org/dc/elements/1.1/" rel="schema.DC"/><meta content="2023-09-09" name="DC.date"/><meta content="time_integration_transient.m" name="DC.source"/><style type="text/css">
            html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

            html { min-height:100%; margin-bottom:1px; }
            html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
            html body td { vertical-align:top; text-align:left; }

            h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
            h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
            h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

            a { color:#005fce; text-decoration:none; }
            a:hover { color:#005fce; text-decoration:underline; }
            a:visited { color:#004aa0; text-decoration:none; }

            p { padding:0px; margin:0px 0px 20px; }
            img { padding:0px; margin:0px 0px 20px; border:none; }
            p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

            ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
            ul li { padding:0px; margin:0px 0px 7px 0px; }
            ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
            ul li ol li { list-style:decimal; }
            ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
            ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
            ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
            ol li ol li { list-style-type:lower-alpha; }
            ol li ul { padding-top:7px; }
            ol li ul li { list-style:square; }

            .content { font-size:1.2em; line-height:140%; padding: 20px; }

            pre, code { font-size:12px; }
            tt { font-size: 1.2em; }
            pre { margin:0px 0px 20px; }
            pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
            pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
            pre.error { color:red; }

            @media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

            span.keyword { color:#0000FF }
            span.comment { color:#228B22 }
            span.string { color:#A020F0 }
            span.untermstring { color:#B20000 }
            span.syscmd { color:#B28C00 }
            span.typesection { color:#A0522D }

            .footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
            .footer p { margin:0px; }
            .footer a { color:#878787; }
            .footer a:hover { color:#878787; text-decoration:underline; }
            .footer a:visited { color:#878787; }

            table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
            table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }

            .center {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 50%;
              }



        </style></head><body><div class="content"><h1>Time integration of transient response</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#2">TIME_INTEGRATION_PERIODIC</a></li><li><a href="#3">Plot initial PO (check)</a></li><li><a href="#5">parsing inputs</a></li></ul></div><pre class="codeinput"><span class="keyword">function</span> varargout = time_integration_transient(obj,Omega,varargin)
        </pre><h2 id="2">TIME_INTEGRATION_PERIODIC</h2><p>This function is used to perform direct numerical time integration of the dynamical system over a range of forcing frequencies such that transients decay to obtain a steady-state periodic response.</p><p><tt>obj</tt>: object of DynamicalSystem class</p><p><tt>Omega</tt>: forcing frequency</p><p>optional arguments:</p><div><ul><li><tt>nCycles</tt>: maximum number of forcing cycles over which transient response is           computed to achieve steady-state</li></ul></div><div><ul><li><tt>nOmega</tt>: number of equally spaced forcing frequencies in omegaRange over           which the periodic response is computed</li></ul></div><div><ul><li><tt>integrationMethod</tt>:  method to be chosen for time integration: 'ode45'                       or 'ode15s' or 'Newmark' or 'Galpha'</li></ul></div><div><ul><li><tt>outdof</tt>: the degree of freedom for which the converged periodic orbit           should be plotted</li></ul></div><div><ul><li><tt>init</tt>: initial condition vector to be used for the first time           integration</li></ul></div><pre class="codeinput">N = obj.N;
[integrationMethod, nCycles, zInit, outdof, nSteps, Plot, samp] =<span class="keyword">...</span>
    parse_inputs(N, varargin{:});

ndof = numel(outdof);

<span class="keyword">if</span> abs(Omega)&lt;1e-10
    T = 2*pi*nCycles;
<span class="keyword">else</span>
    T = 2*pi/Omega*nCycles;
<span class="keyword">end</span>
obj.Omega = Omega;
odefun = @(t,x) obj.<a href="../../../Library/DynamicalSystem/odefun.html">odefun</a>(t,x);
residual = @(q,qd,qdd,t)obj.<a href="../../../Library/DynamicalSystem/residual.html">residual</a>(q,qd,qdd,t);

<span class="comment">% forward simulation</span>
<span class="keyword">switch</span> integrationMethod
    <span class="keyword">case</span> <span class="string">'ode45'</span>
        <span class="comment">% transient time integration to converging to steady-state</span>
<span class="comment">%         odeoptions = odeset('RelTol',1e-9,'AbsTol',1e-9);</span>
        [t0, x0] = ode45(odefun, linspace(0,T,nSteps*nCycles+1), zInit);

    <span class="keyword">case</span> <span class="string">'ode15s'</span>
<span class="comment">%         odeoptions = odeset('RelTol',1e-9,'AbsTol',1e-9);</span>
        [t0, x0] = ode15s(odefun, linspace(0,T,nSteps*nCycles+1), zInit);

    <span class="keyword">case</span> {<span class="string">'Newmark'</span>, <span class="string">'Galpha'</span>}
        <span class="comment">% Instantiate object for nonlinear time integration</span>
        <span class="keyword">if</span> abs(Omega)&lt;1e-10
            h = 2*pi/nSteps;
        <span class="keyword">else</span>
            h = 2*pi/Omega/nSteps;
        <span class="keyword">end</span>
        n = obj.n;
        <span class="keyword">if</span> strcmp(integrationMethod,<span class="string">'Newmark'</span>)
            TI = ImplicitNewmark(<span class="string">'timestep'</span>,h,<span class="string">'alpha'</span>,0.005);
        <span class="keyword">elseif</span> strcmp(integrationMethod,<span class="string">'Galpha'</span>)
            TI = GeneralizedAlpha(<span class="string">'timestep'</span>,h,<span class="string">'rho_inf'</span>,0.7);
        <span class="keyword">end</span>
        <span class="comment">% Residual evaluation function handle</span>
        q0 = zInit(1:n); qd0 = zInit(n+1:N);
        qdd0 = obj.M\(obj.<a href="../../../Library/DynamicalSystem/compute_fext.html">compute_fext</a>(0) - obj.C*qd0 - obj.K*q0 <span class="keyword">...</span>
            - obj.<a href="../../../Library/DynamicalSystem/compute_fnl.html">compute_fnl</a>(q0,qd0));

        <span class="comment">% Nonlinear Time Integration</span>
        TI.Integrate(q0,qd0,qdd0,T,residual);

        x0 = full([TI.Solution.q; TI.Solution.qd]).';
        t0 = TI.Solution.time;

    <span class="keyword">otherwise</span>
        error(<span class="string">'Unknown integration method chosen \n Valid choices are ode45, ode15s, Newmark and Galpha'</span>)

<span class="keyword">end</span>

<span class="comment">% save output</span>
save(<span class="string">'traj.mat'</span>,<span class="string">'x0'</span>, <span class="string">'t0'</span>,<span class="string">'Omega'</span>)

varargout{1} = t0(1:samp:end);
<span class="keyword">if</span> outdof(1)&gt;0
    varargout{2} = x0(1:samp:end,outdof);
    varargout{3} = x0(end,:); <span class="comment">% final state</span>
<span class="keyword">end</span>
        </pre><h2 id="3">Plot initial PO (check)</h2><pre class="codeinput"><span class="keyword">if</span> outdof(1)&gt;0 &amp;&amp; Plot
    <span class="keyword">for</span> i=1:ndof
        figure;
        i1 = outdof(i);
        plot(t0, x0(:,i1), <span class="string">'LineWidth'</span>, 2);
        xlabel(<span class="string">'time'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>); ylabel(<span class="string">'z'</span>,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>)
        title([<span class="string">'Periodic orbit \Omega= '</span> num2str(Omega)])
        set(gca, <span class="string">'LineWidth'</span>, 1.5);
        set(gca, <span class="string">'FontSize'</span>, 14);
        axis <span class="string">square</span>
        saveas(gcf,[<span class="string">'po_'</span> num2str(i1), <span class="string">'.fig'</span>])
        close(gcf)
    <span class="keyword">end</span>
<span class="keyword">end</span>
        </pre><pre class="codeinput"><span class="keyword">end</span>


<span class="keyword">function</span> [integrationMethod,nCycles,zInit,outdof,nSteps,Plot,samp] = parse_inputs(N,varargin)
        </pre><h2 id="5">parsing inputs</h2><pre class="codeinput">defaultinit = zeros(N,1);
defaultncycles = 5000;
defaultIntegrationMethod = <span class="string">'ode45'</span>;
defaultoutdof = 0;
defaultnSteps = 30;
defaultPlot = false;
defaultSampGap = 1;

p = inputParser;
addParameter(p,<span class="string">'nSteps'</span>,defaultnSteps, @(x)validateattributes(x, <span class="keyword">...</span>
    {<span class="string">'numeric'</span>},{<span class="string">'nonempty'</span>,<span class="string">'integer'</span>,<span class="string">'positive'</span>}) );
addParameter(p,<span class="string">'outdof'</span>,defaultoutdof, @(x)validateattributes(x, <span class="keyword">...</span>
    {<span class="string">'numeric'</span>},{<span class="string">'nonempty'</span>,<span class="string">'integer'</span>,<span class="string">'nonnegative'</span>}) );
addParameter(p,<span class="string">'nCycles'</span>,defaultncycles, @(x)validateattributes(x, <span class="keyword">...</span>
    {<span class="string">'numeric'</span>},{<span class="string">'nonempty'</span>,<span class="string">'integer'</span>,<span class="string">'positive'</span>}) );
addParameter(p,<span class="string">'integrationMethod'</span>,defaultIntegrationMethod);
addParameter(p,<span class="string">'init'</span>,defaultinit);
addParameter(p,<span class="string">'plot'</span>,defaultPlot);
addParameter(p,<span class="string">'samp'</span>,defaultSampGap);


parse(p,varargin{:});

integrationMethod = p.Results.integrationMethod;
nCycles = p.Results.nCycles;
zInit = p.Results.init;
outdof = p.Results.outdof;
nSteps = p.Results.nSteps;
Plot = p.Results.plot;
samp = p.Results.samp;
        </pre><pre class="codeinput"><span class="keyword">end</span>
        </pre><p class="footer"><br/><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB® R2023a</a><br/></p></div><!--
            ##### SOURCE BEGIN #####
            %% Time integration of transient response
%
%%
function varargout = time_integration_transient(obj,Omega,varargin)
%% TIME_INTEGRATION_PERIODIC
% This function is used to perform direct 
% numerical time integration of the dynamical system over a 
% range of forcing frequencies such that transients decay to obtain a
% steady-state periodic response.
%
% |obj|: object of DynamicalSystem class
%
% |Omega|: forcing frequency
%
% optional arguments:
%
% * |nCycles|: maximum number of forcing cycles over which transient response is
%           computed to achieve steady-state
%
% * |nOmega|: number of equally spaced forcing frequencies in omegaRange over
%           which the periodic response is computed
%
% * |integrationMethod|:  method to be chosen for time integration: 'ode45'
%                       or 'ode15s' or 'Newmark' or 'Galpha'
%
% * |outdof|: the degree of freedom for which the converged periodic orbit 
%           should be plotted
%
% * |init|: initial condition vector to be used for the first time
%           integration
%

N = obj.N;
[integrationMethod, nCycles, zInit, outdof, nSteps, Plot, samp] =...
    parse_inputs(N, varargin{:});

ndof = numel(outdof);

if abs(Omega)<1e-10
    T = 2*pi*nCycles;
else
    T = 2*pi/Omega*nCycles;
end
obj.Omega = Omega;
odefun = @(t,x) obj.<a href="../../../Library/DynamicalSystem/odefun.html">odefun</a>(t,x);    
residual = @(q,qd,qdd,t)obj.<a href="../../../Library/DynamicalSystem/residual.html">residual</a>(q,qd,qdd,t);

% forward simulation
switch integrationMethod
    case 'ode45'
        % transient time integration to converging to steady-state
%         odeoptions = odeset('RelTol',1e-9,'AbsTol',1e-9);
        [t0, x0] = ode45(odefun, linspace(0,T,nSteps*nCycles+1), zInit);

    case 'ode15s'
%         odeoptions = odeset('RelTol',1e-9,'AbsTol',1e-9);
        [t0, x0] = ode15s(odefun, linspace(0,T,nSteps*nCycles+1), zInit);

    case {'Newmark', 'Galpha'}
        % Instantiate object for nonlinear time integration
        if abs(Omega)<1e-10
            h = 2*pi/nSteps;
        else
            h = 2*pi/Omega/nSteps;
        end
        n = obj.n;
        if strcmp(integrationMethod,'Newmark')
            TI = ImplicitNewmark('timestep',h,'alpha',0.005);
        elseif strcmp(integrationMethod,'Galpha')
            TI = GeneralizedAlpha('timestep',h,'rho_inf',0.7);
        end
        % Residual evaluation function handle            
        q0 = zInit(1:n); qd0 = zInit(n+1:N); 
        qdd0 = obj.M\(obj.<a href="../../../Library/DynamicalSystem/compute_fext.html">compute_fext</a>(0) - obj.C*qd0 - obj.K*q0 ...
            - obj.<a href="../../../Library/DynamicalSystem/compute_fnl.html">compute_fnl</a>(q0,qd0));

        % Nonlinear Time Integration
        TI.Integrate(q0,qd0,qdd0,T,residual);

        x0 = full([TI.Solution.q; TI.Solution.qd]).';
        t0 = TI.Solution.time;

    otherwise
        error('Unknown integration method chosen \n Valid choices are ode45, ode15s, Newmark and Galpha')            

end

% save output
save('traj.mat','x0', 't0','Omega')

varargout{1} = t0(1:samp:end);
if outdof(1)>0
    varargout{2} = x0(1:samp:end,outdof);
    varargout{3} = x0(end,:); % final state
end

%% Plot initial PO (check)
if outdof(1)>0 && Plot
    for i=1:ndof
        figure;
        i1 = outdof(i);
        plot(t0, x0(:,i1), 'LineWidth', 2);
        xlabel('time','interpreter','latex'); ylabel('z','interpreter','latex')
        title(['Periodic orbit \Omega= ' num2str(Omega)])
        set(gca, 'LineWidth', 1.5);
        set(gca, 'FontSize', 14);
        axis square        
        saveas(gcf,['po_' num2str(i1), '.fig'])
        close(gcf)
    end
end

end


function [integrationMethod,nCycles,zInit,outdof,nSteps,Plot,samp] = parse_inputs(N,varargin)
%% parsing inputs
defaultinit = zeros(N,1);
defaultncycles = 5000;
defaultIntegrationMethod = 'ode45';
defaultoutdof = 0;
defaultnSteps = 30;
defaultPlot = false;
defaultSampGap = 1;

p = inputParser;
addParameter(p,'nSteps',defaultnSteps, @(x)validateattributes(x, ...
    {'numeric'},{'nonempty','integer','positive'}) );
addParameter(p,'outdof',defaultoutdof, @(x)validateattributes(x, ...
    {'numeric'},{'nonempty','integer','nonnegative'}) );
addParameter(p,'nCycles',defaultncycles, @(x)validateattributes(x, ...
    {'numeric'},{'nonempty','integer','positive'}) );
addParameter(p,'integrationMethod',defaultIntegrationMethod);
addParameter(p,'init',defaultinit);
addParameter(p,'plot',defaultPlot);
addParameter(p,'samp',defaultSampGap);


parse(p,varargin{:});

integrationMethod = p.Results.integrationMethod;
nCycles = p.Results.nCycles;
zInit = p.Results.init;
outdof = p.Results.outdof;
nSteps = p.Results.nSteps;
Plot = p.Results.plot;
samp = p.Results.samp;
end

            ##### SOURCE END #####
        --></body></html></body></html>